<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>SMG Run smg Howto</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 48em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      word-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<h1 id="how-to-run-smg-and-follow-howtos">How to run SMG and follow howtos</h1>
<p>The easiest way to run SMG these days is using the OCI-compatible container image. It comes bundled with a bunch of service clients needed to access services natively (e.g. redis, mysql clients etc).</p>
<p>The actual container runtime does not need to be Docker but the examples below will use docker as the most popular choice. Note that these commands should be mostly compatible with RedHat’s podman too.</p>
<p>SMG needs two logical persistent volumes to be kept across container restarts</p>
<ul>
<li>a data volume, mounted under /opt/smg/data</li>
<li>(optional) configuration volume, mounted under /etc/smg/conf.d/</li>
</ul>
<p>The /etc/smg/conf.d/ directory is intended for “manual” configs (in the Kubernetes case these would normally be ConfigMaps). Typycally one would configure any needed SMG globals there, notification recipients etc and possibly some one-off stats. It is not strictly required for basic SMG functioning.</p>
<p>The /opt/smg/data directory will be used by SMG to store all persistent data including actual rrd files under /opt/smg/data/rrd/, monitor logs, monitor states persisted across restarts but can also contain target configs the autoconf plugin (/opt/smg/data/conf/autoconf.d/). These can be maintained by human or managed/generated by a Configuration Management system like Ansible or Chef, or in the Kubernetes case - the Kube (autodiscovery) plugin. Note that the SMG autoconf plugin will also use targets defined in /etc/smg/autoconf.d/, which is the intended location for “manually” managed targets. One can mount that as another persistent mount and use it, however the examples in these howtos will use /opt/smg/data/conf/autoconf.d/ for simplicity.</p>
<p>The autconf private (conf/autoconf-private.d/) directory also lives under /opt/smg/data - this directory contains all autoconf targets template outputs and is normally owned/managed by the plugin. That (/opt/smg/data/conf/autoconf-private.d) directory is included by the bundled with the image /etc/smg/config.yml which is required for autoconf to function.</p>
<p>Here are some example commands to get the SMG image up and running on a local Linux machine.</p>
<pre><code>$ sudo mkdir -p /opt/smg/data /etc/smg/conf.d ; sudo chown `whoami` /etc/smg/conf.d /opt/smg/data
$ docker run -d --name smg -p 9000:9000 \
    -v /etc/smg/conf.d:/etc/smg/conf.d -v /opt/smg/data:/opt/smg/data \
    gcr.io/asen-smg/smulegrapher:latest</code></pre>
<p>Point your browser to http://%DOCKER_HOST%:9000 (the local SMG stats should show up in a minute or two). Note that its possible to run SMG in root-less container runtime (tested with podman docker emulation). Also the /etc/smg and /opt/smg dirs don’t need to be in a system-wide location (can be under your home dir), yet these are used with the examples in the howtos for consistency.</p>
<p>Then add stuff under /etc/smg/conf.d or /opt/smg/data/conf/autoconf.d/ and to reload conig use one of:</p>
<pre><code>$ docker exec smg /opt/smg/inst/smg/smgscripts/reload-conf.sh</code></pre>
<p>or</p>
<pre><code>$ curl -X POST http://%DOCKER_HOST%:9000/reload</code></pre>
<p>Use the docker logs command to check for errors if something does not look right.</p>
<p>Note that such setup is fine for small-scale operations (like up to a few thousands of graphs updated every minute). For more demanding/production setups it is recommended to use rrdcached for batching the writes and nginx to serve the images.</p>
<p>Use the <a href="https://github.com/asen/smg/blob/master/docker/docker-compose.yaml">docker/docker-compose.yaml</a> file in the SMG repo to easily bring up a production-ready SMG setup.</p>
<pre><code>$ sudo mkdir -p /etc/smg/conf.d ; sudo mkdir -p /opt/smg/data ; sudo chown `whoami` /etc/smg/conf.d /opt/smg/data
$ git clone https://github.com/asen/smg.git
$ cd smg/docker
$ docker-compose up -d</code></pre>
<p>or (with podman)</p>
<pre><code>$ podman-compose up -d</code></pre>
<p>Point your browser to http://%DOCKER_HOST%:9080 (the local metrics stats should show up in a minute or two)</p>
<p>And if you are running Kubernetes - check the <a href="https://github.com/asen/smg/tree/master/k8s/">k8s/</a> dir for example production deployment.</p>
</body>
</html>
