<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Smule Grapher (SMG)</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      word-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header id="title-block-header">
<h1 class="title">Smule Grapher (SMG)</h1>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#introduction">Introduction</a>
<ul>
<li><a href="#what-is-it">What is it</a></li>
</ul></li>
<li><a href="#install">Install</a></li>
<li><a href="#ui-orientation">UI orientation</a></li>
<li><a href="#concepts-overview">Concepts overview</a>
<ul>
<li><a href="#concepts---toc">Concepts - TOC</a></li>
<li><a href="#rrd-objects">RRD objects</a></li>
<li><a href="#intervals-runs-and-scheduler">Intervals, runs and scheduler</a></li>
<li><a href="#pre_fetch-and-run-command-trees">pre_fetch and run command trees</a></li>
<li><a href="#period-since-and-period-length">Period since and period length</a></li>
<li><a href="#filters">Filters</a>
<ul>
<li><a href="#remote-filter">Remote filter</a></li>
<li><a href="#text-regex-filter">Text Regex filter</a></li>
<li><a href="#prefix-filter">Prefix filter</a></li>
<li><a href="#suffix-filter">Suffix filter</a></li>
<li><a href="#regex-filter">Regex filter</a></li>
<li><a href="#regex-exclude-filter">Regex Exclude filter</a></li>
<li><a href="#parent-regex-filter">Parent Regex filter</a></li>
<li><a href="#labels-filter">Labels filter</a></li>
<li><a href="#index-filter">Index filter</a></li>
</ul></li>
<li><a href="#indexes">Indexes</a></li>
<li><a href="#custom-dashboards">Custom dashboards</a></li>
<li><a href="#graph-options">Graph options</a>
<ul>
<li><a href="#step">Step</a></li>
<li><a href="#maxy">MaxY</a></li>
<li><a href="#miny">MinY</a></li>
<li><a href="#rows-and-columns">Rows and columns</a></li>
<li><a href="#sorting">Sorting</a></li>
</ul></li>
<li><a href="#aggregate-functions">Aggregate functions</a></li>
<li><a href="#view-objects-and-calculated-graphs">View objects and calculated graphs</a></li>
<li><a href="#remotes">Remotes</a></li>
<li><a href="#plugins">Plugins</a>
<ul>
<li><a href="#currently-available-plugins">Currently available plugins</a></li>
</ul></li>
<li><a href="#monitoring">Monitoring</a>
<ul>
<li><a href="#anomaly-detection-via-the-mon-check-plugin">Anomaly detection (via the “mon” check plugin)</a></li>
</ul></li>
</ul></li>
<li><a href="#configuration-reference">Configuration Reference</a>
<ul>
<li><a href="#configuration-reference---toc">Configuration Reference - TOC</a></li>
<li><a href="#globals">Globals</a></li>
<li><a href="#rrd-objects-1">RRD objects</a></li>
<li><a href="#aggrgegate-rrd-objects">Aggrgegate RRD objects</a></li>
<li><a href="#view-objects">View objects</a></li>
<li><a href="#indexes-1">Indexes</a>
<ul>
<li><a href="#filters-and-graph-options">Filters and graph options</a></li>
</ul></li>
<li><a href="#hidden-indexes">Hidden Indexes</a></li>
<li><a href="#custom-dashboards-configuration">Custom dashboards configuration</a></li>
<li><a href="#monitoring-configuration">Monitoring configuration</a></li>
</ul></li>
<li><a href="#bundled-plugins-configuration">Bundled Plugins configuration</a></li>
<li><a href="#running-and-troubleshooting">Running and troubleshooting</a>
<ul>
<li><a href="#run-in-a-container">Run in a container</a></li>
<li><a href="#run-in-k8s">Run in k8s</a></li>
<li><a href="#classic-mode">Classic mode</a>
<ul>
<li><a href="#pre-requisites">Pre-requisites</a></li>
<li><a href="#installation-from-.tgz-bundle">Installation from .tgz bundle</a></li>
<li><a href="#installation-from-sources">Installation from sources</a></li>
<li><a href="#reverse-proxy">Reverse proxy</a></li>
</ul></li>
</ul></li>
<li><a href="#developer-documentation">Developer documentation</a>
<ul>
<li><a href="#development-setup">Development setup</a></li>
</ul></li>
</ul>
</nav>
<h2 id="introduction">Introduction</h2>
<h3 id="what-is-it">What is it</h3>
<p>Smule Grapher (SMG) is a Play 2.x/Scala app used to retrieve data from arbitrary monitored services (generally - using external/bash commands) and using rrdtool to maintain many RRD databases with the retrieved data and then plot and display time-series graphs (and more) from them.</p>
<p>Some Features:</p>
<ul>
<li>simple config suitable for being generated from a configuration management system, like Chef/Puppet etc. E.g</li>
</ul>
<pre>
    - some.var:
      command: /path/to/script_outputting_var_value.sh
      vars:
        - label: var1
</pre>
<ul>
<li>arbitrary number of vars per object/graph allowed (though defining more than 10 is rarely a good idea)</li>
<li>single instance/config can specify and work with different update periods - like evey minute (the default), every 5 minutes, every hour etc.</li>
<li>script_outputting_var_value.sh can be a mrtg-compatible helper script</li>
<li>Remote instances support. One can have multiple instances spread across different geo locations but use single UI access point for all.</li>
<li>Built-in advanaced monitoring on any graphed value</li>
<li>Aggregate functions allowing to see the sum/average/etc from arbitrary number of (compatible) values</li>
<li>Scala plugins support - it is possible to extend SMG by writing plugins for custom functionality including custom data input sources which do not necessarily fit the model where external command is executed on regular interval to fetch the values for updates. E.g. SMG comes with a JMX plugin which keeps persistent connections to the target Java JMX servers. It is also possible to create custom actions attached to graphs using plugins including e.g. visualizations. SMG comes with javascript-based “Zoom” functionality based on the open source plot.ly JS graphing library.</li>
<li>Support for OpenMetrics (Prometheus) /metrics end-points scrapping and graphs via the Scrape plugin. In addition it is now possible to monitor back-end services (like redis/mysql etc) natively using the Autoconf plugin - based on templates. This replaces the need to run Prometheus “exporters” and can use native clients to get stats from the monitored service. All this can be used with the Kube plugin and K8s annotations for a complete monitoring solution including alerts and graphs.</li>
</ul>
<p>See concepts overview below for more details. There is also now a (long) document explaining the <a href="History_and_Evolution.html">history and evolution of SMG</a> which covers these concepts in more detail and the use cases which they are intended to address.</p>
<h2 id="install">Install</h2>
<p>SMG can be installed and run from a Docker image, a pre-built .tgz or run directly from sources.</p>
<p>See the <a href="https://github.com/asen/smg/blob/master/README.md">README.md</a> in the source tree for most up to date install instructions</p>
<h2 id="ui-orientation">UI orientation</h2>
<p>SMG’s main page (/) displays a list of <a href="#concepts-indexes">configured top-level indexes</a> (this is where the <strong>Configured indexes</strong> menu item points to). These are links to filter result pages (/dash) with pre-set <a href="#concepts-filters">filters</a>. The later page is where one can also enter custom filters to customize the set of displayed objects (possibly - narrowing down the defined in the index filter). You can get an “empty” (match-all) filter by clicking the <strong>All Graphs</strong> link in the top menu. The <strong>Automatic index</strong> represents a tree structure which SMG will automatically create from all object ids. That looks much better if the object ids follow a hierarchical structure where “levels” are seprated by dots. The <strong>Search</strong> menu item allows searching for both objects and indexes. The <strong>Monitor</strong> menu item displays current issues as detected by the <a href="#concepts-monitoring">monitoring system</a>. Any registered SMG <a href="#concepts-plugins">plugins</a> can show up as menu items too.</p>
<p><a name="concepts" /></p>
<h2 id="concepts-overview">Concepts overview</h2>
<p>SMG uses the (excellent) <a href="http://oss.oetiker.ch/rrdtool/">rrdtool</a> tool to store the values it fetches from external services into so called Round Robin Database (RRD) files. Both cacti and mrtg (in rrdtool mode) use rrdtool, so chances are you are already familiar with what to expect from these. Check the tool homepage for more details but in a nutshell RRD files are with fixed (upon creation) size which store series of numbers over different periods using bigger averaging steps the older the data gets. So rrdtool (and in turn - SMG) keeps most recent data (by default - 96h in SMG) into the minimal for SMG run interval (default -every minute) granularity (which corresponds to maximal resolution) and older data gets averaged over longer period and kept like that (at smaller resolution).</p>
<h3 id="concepts---toc">Concepts - TOC</h3>
<ol type="1">
<li><a href="#concepts-rrd-objects">RRD objects</a></li>
<li><a href="#concepts-intervals">Intervals, runs and scheduler</a></li>
<li><a href="#concepts-pre_fetch">pre_fetch and run command trees</a></li>
<li><a href="#concepts-period">Period since and period length</a></li>
<li><a href="#concepts-filters">Filters</a></li>
<li><a href="#concepts-indexes">Indexes</a></li>
<li><a href="#concepts-cdash">Custom dahsboards</a></li>
<li><a href="#concepts-gopts">Graph options</a></li>
<li><a href="#concepts-aggregate-functions">Aggregate functions</a></li>
<li><a href="#concepts-view-objects">View objects and calculated graphs</a></li>
<li><a href="#concepts-remotes">Remotes</a></li>
<li><a href="#concepts-plugins">Plugins</a></li>
<li><a href="#concepts-monitoring">Monitoring</a>
<ol type="1">
<li><a href="#concepts-anomaly">Anomaly detection</a></li>
</ol></li>
</ol>
<p><a name="concepts-rrd-objects" /></p>
<h3 id="rrd-objects">RRD objects</h3>
<p>Every graph in SMG corresponds to one or more (check aggregate functions below) RRD objects. These are configured in the yaml config and have a bunch of properties (described in detail in the <a href="#rrd-objects">config section</a> of these docs).</p>
<p>The object id is a string (unique across object ids namespace), should be descriptive and must only contain alpha numeric characters and some symbols like ‘-’, ’_’ and ‘.’.</p>
<p>The dot can be considered somewhat special as SMG can build an automatic index tree by considering the dot as a level separator and grouping objects with common prefixes. So a good object id can look like this: <strong>class.hostname.svcname</strong> (Example: <em>host.a1.sysload</em>). Note that this is only by convention and it is not enforced by SMG, however having good object ids is critical to be able to use it effectively (see Filters below).</p>
<p>Each rrd object also defines one or more variables (<strong>vars</strong>) and the external <strong>command</strong> is expected to output (at least) as many numbers when invoked, one per line. Getting less lines or non-numbers will cause an error (a NaN will be recorded in the RRD). Getting more lines will not trigger an error and SMG will only use the first N (equal to number of variables) lines. This is intentional and is in order to support mrtg helper scripts directly (these normally output hostname and uptime at the end).</p>
<p>Every RRD object also has an <strong>interval</strong> associated with it. That determines how often the command specified in the config will be executed and its output (numbers) recorded in the RRD file. The default interval if not specified in the config is 60 seconds (or every minute).</p>
<p>Check <a href="#rrd-objects">RRD Objects configuration</a> for more details on what properties are supported for given RRD object.</p>
<p>In addition to regular RRD objects (with values for update coming from external command output) SMG supports Aggregate Rrd Objects. These don’t have their own command to run but instead use values fetched for multiple other regular RRD objects to produce a single aggregate value for every variable defined and then update that in a RRD file. These are distinguished from regular RRD objects by prepending a ‘+’ to the object id in the yaml config.</p>
<p>Check <a href="#rrd-agg-objects">Aggregate RRD Objects configuration</a> for more details on what properties are supported for given Aggregate RRD object.</p>
<p><a name="concepts-intervals" /></p>
<h3 id="intervals-runs-and-scheduler">Intervals, runs and scheduler</h3>
<p>SMG has the concept of regular (every <em>interval</em> seconds) <em>runs</em> where it will execute the commands specified in the objects configs. All objects having the same interval config value will be processed during the respective interval run (also see the next section on pre_fetch and run trees). All per-interval runs execute in their own separate thread pool, so that e.g. slow hourly commands do not interfere too much with fast every-minute commands. Aggregate RRD object updates happen after all regular rrd objects have been updated, at the end of the interval run. Thread pools are configurable via the $interval_def global.</p>
<p>By default SMG will use its internal scheduler to trigger the regular runs. Without getting into too much detail here it will trigger (separate) runs for every discovered unique rrd object (or plugin) interval value, whenever the applicable time comes. If desired one can also use an external scheduler like cron. For this to work one needs to set <em>smg.useInternalScheduler</em> in application.conf to <em>false</em> and then schedule the smgscripts/run-job.sh script as cron jobs (per interval, passed as param to run-job.sh) as needed.</p>
<p><a name="concepts-pre_fetch" /></p>
<h3 id="pre_fetch-and-run-command-trees">pre_fetch and run command trees</h3>
<p>One important thing when trying to get and update RRDs for tens of thousands of values from remote servers every minute is to reduce the number of remote connections one has to make to the target (monitored) servers. For example in mrtg (and if not misatken - in cacti too) every object configured results in a call to a separate external command getting remote data and/or a SNMP get.</p>
<p>Instead (and ideally) we would use a single command to get all the values we want from a given host and then possibly produce many rrd objects and graphs from these.</p>
<p>This is where SMG’s pre_fetch simplifies things - it is a special config object defining an id and a command to execute. Then RRD objects can have a pre_fetch attribute specified with a value - the mentioned pre_fetch id.</p>
<p>This allows the pre_fetch command to store its ouput data cached somehere locally on the SMG host and then the actual RRD object commands do not need to go to the target server but can use the cached local data. For example we use a pre_fetch command to get all SNMP values we care about from a given host in a single shot (about sysload, cpu usage, i/o, mem etc). Then we update many RRD objects from the pre-fetched data. Since recently pre_fetch also supports passing the command stdout directly to the child command stdin without the need to use temp files.</p>
<p>In addition pre_fetch itself can specify another pre_fetch command to be its parent. That way one can define a hierarchical command tree structure (“run tree”) where many child commands depend on a single parent command and a set of parents can define a common parent of their own etc. Example use case for this is to define a top-level <em>ping -c 1 ip.addr</em> pre_fetch command for given host and then all other pre_fetches (or actual rrd objects) for that host can have the ping pre_fetch defined as parent and will not run at all if e.g. the host is down (not ping-able). Having such setup will also make SMG only send a single “failed” alert if a host is down (vs alerts for each individual command).</p>
<p>An important note is that SMG will execute child pre-fetch commands in sequence (but not rrd object commands which are always parallelized up to the max concurrency level configured for the interval). The intent is to be able to limit the number of concurrent probes hitting some target host to 1 per interval. This behavior can be overriden by setting the <strong>child_conc</strong> property on the pre-fetch command to more than the default 1 (setting the number of max concurrent threads that can execute child pre-fetches of this pre-fetch).</p>
<p><a name="concepts-period" /></p>
<h3 id="period-since-and-period-length">Period since and period length</h3>
<p>By default SMG will plot graphs for a period starting at some point back in time and ending “now”. The starting point is determined by the <strong>Period Since</strong> UI param (default is 24h). Sometimes one may want to use a different end point in the graphs than “now”. This can be requested using the <strong>Period Len</strong> UI param, specifying how long period the graphs should cover (starting at the point defined with Period Since). Both parameters and their format are described in detail <a href="#period">here</a></p>
<p><a name="concepts-filters" /></p>
<h3 id="filters">Filters</h3>
<p>SMG maintains the list of all objects available for graphing in memory.</p>
<p>Whenever it has to display some set of (different objects) graphs, the selection happens via a filter over the global list. This is how one selects which graphs to see on the page. This is also why object ids are very important, so that you can easily select classes of objects to display together.</p>
<p>Currently one can filter by object id, object title and <a href="#concepts-remotes">remote instance</a>. Below are the currently supported filter fields as present in the UI. These match the <a href="#filters">index filter configuration</a> options and if any filter turns out to be useful it can be converted to a named index and configured in the yaml for quick access. Also any filter result can be shared by just sharing its SMG URL - the filter fields are sent as plain URL params to SMG.</p>
<p><strong>Note:</strong> Using regex filter on object id and title to define groups of objects may look awkward at first sight but is actually quite powerful (and the idea was “borrowed” from <a href="http://oss.oetiker.ch/mrtg/doc/indexmaker.en.html">mrtg indexmaker</a>). By using good object ids to “describe” the SMG objects admins can save themselves the need to explicitly define too many object (grouping/classification) properties upfront, but instead easily use the filters to define arbitrary groups later when needed.</p>
<p><a name="flt-remote" /></p>
<h4 id="remote-filter">Remote filter</h4>
<ul>
<li>a drop down to select a specific <a href="#concepts-remotes">remote instances</a> to search in or to search in all remotes via the special asterisk <em>*</em> remote id. Note that this filter is not visible unless there is at least one configured remote instance.</li>
</ul>
<p><a name="flt-titlerx" /></p>
<h4 id="text-regex-filter">Text Regex filter</h4>
<ul>
<li>when set, only objects where any of object id, title, var labels or measurement units is matched by the specified regular expressions will be matched by the filter.</li>
</ul>
<p><a name="flt-prefix" /></p>
<h4 id="prefix-filter">Prefix filter</h4>
<ul>
<li>when set, only object ids having the specified prefix string (starting with it) will be matched by the filter. Note that this is not a regexp but a direct string comparison (and e.g dots are not special match-all symbols).</li>
</ul>
<p><a name="flt-suffix" /></p>
<h4 id="suffix-filter">Suffix filter</h4>
<ul>
<li>when set, only object ids having the specified suffix string (ending with it) will be matched by the filter. Note that similar to prefix filter this is not a regexp but a direct string comparison.</li>
</ul>
<p><a name="flt-regex" /></p>
<h4 id="regex-filter">Regex filter</h4>
<ul>
<li>when set, only object ids matching the specified regular expressions will be matched by the filter.</li>
</ul>
<p><a name="flt-rxexclude" /></p>
<h4 id="regex-exclude-filter">Regex Exclude filter</h4>
<ul>
<li>when set, only object ids NOT matching the specified regular expressions will be matched by the filter.</li>
</ul>
<p><a name="flt-prx" /></p>
<h4 id="parent-regex-filter">Parent Regex filter</h4>
<ul>
<li>when set, only objects whose parent ids match the specified regular expressions will be matched by the filter.</li>
</ul>
<p><a name="flt-labels" /></p>
<h4 id="labels-filter">Labels filter</h4>
<ul>
<li>when set, only objects whitch match the corresponding object labels expression will be matched by the filter.</li>
</ul>
<p><a name="flt-index" /></p>
<h4 id="index-filter">Index filter</h4>
<ul>
<li>Where Index (<a href="#indexes">described below</a>) itself defines a filter, the index id is a “first class” filter member too. So when visiting an Index url one sees the index filter separately from the user filter and the user filter works only within the already filtered by the index filter list of objects. The UI provides options to remove the index filter or merge it with the user filter resulting in an “index-free” filter.</li>
</ul>
<p><a name="concepts-indexes" /></p>
<h3 id="indexes">Indexes</h3>
<p>An index is basically a named filter with some additional properties. One can configure indexes in the yaml config and SMG can auto-discover indexes with good object ids structure. Indexes can be structured in a hierarchy where each index can specify a parent index id. The main SMG page currently displays all top-level indexes (ones which don’t have a parent) and also the a configurable number of levels after that (using the <a href="#index-tree-levels">$index-tree-levels</a> global var). Check <a href="#indexes">the index config section</a> for more details on indexes.</p>
<p><a name="concepts-cdash" /></p>
<h3 id="custom-dashboards">Custom dashboards</h3>
<p>The custom dashboard represents a single page which can combine the graphs outputs from multiple indexes on a single page. The layout of the page can defined using sizes in the configuration. In addition it can display monitor states and/or logs plus external items via iframe. Check the <a href="#cdash">$cdash</a> config options for more details.</p>
<p><a name="concepts-gopts" /></p>
<h3 id="graph-options">Graph options</h3>
<p>These generally allow one to set some non-default graph options, when desired. By default SMG will plot the data for the requested period but also plot the previous period of the same length using dotted lines. It will also plot a dashed line at the 95 perecntile value for each plotted variable. Both of these can be disabled using the respective check-box in the filter UI.</p>
<p><a name="concepts-step" /></p>
<h4 id="step">Step</h4>
<p>By default rrdtool will pick the “best” possible step (what period a data point in the graph will correspond to) based on the available in RRAs data and the requested period. Usually that will be the highest available resolution data which would also fit on the graph. E.g. for graphs updated every minute, SMG will display 1 data point per minute (1-min average) on a 24-hours graph. If we want to see the data at 5-minute average values we could set step to 300 (seconds) and get that.</p>
<p><a name="concepts-maxy" /></p>
<h4 id="maxy">MaxY</h4>
<p>Sometimes one would get big “spikes” in the data where for a short period the data points values get orders of magnitude higher than normal. When displaying such a graph one usually sees a huge spike and the values around it look like a flat line, close to 0. So in order to see details around such spikes one can set the <strong>MaxY</strong> (maximum Y) value of the graphs. Such a graph will have a gap where the spike was occurring but the surrounding time series data can be seen in a good detail.</p>
<p><a name="concepts-miny" /></p>
<h4 id="miny">MinY</h4>
<p>Similar to MaxY, MinY determines the minimum Y value which will be displayed on the graphs.</p>
<p><a name="concepts-rows-and-cols" /></p>
<h4 id="rows-and-columns">Rows and columns</h4>
<p>Whenever SMG displays the graphs resulting from the given filter it uses the <strong>Rows</strong> and <strong>Columns</strong> form parameter values to limit the displayed graphs (it is unlikely that we want 10000 graphs displayed on one page). So one would see at most “Columns” columns of graphs in a “row” (may be less, depending on screen size) with at most “Rows” rows per page.</p>
<p><a name="concepts-sorting" /></p>
<h4 id="sorting">Sorting</h4>
<p>SMG supports sorting a displayed page of graphs by the average value of a given object variable. The object variable is specified via the 1-based integer position of the variable within the list of object ones - the <em>x-sort</em> dashboard filter form field.</p>
<p>For example if you have page of graphs showing network switch ports (objects with two variables - one for incoming and one for outgoing traffic) and if you want to sort them by their outgoing traffic (that would be the second var in the object’s vars list) you would set <em>x-sort</em> = 2. The default <em>x-sort</em> value (0) implies no sorting.</p>
<p>One important note is that sorting is an expensive operation - it involves a <em>rrdtool fetch</em> command in addition to the graph command (<em>rrdtool graph</em>) and the former is almost as expensive as the later. Because of this currently SMG will only sort within the currently displayed page of graphs. This is mainly to avoid cases where (possibly by mistake) one can try to sort all graphs (possibly hundreds of thousands) by setting x-sort to 1 on a match-all filter.</p>
<p>The current workaround to that limitation is to set a high-enough <em>rows</em> parameter so you get all the graphs you want to sort on one page which you can sort after.</p>
<p>A special case of sorting is group by (with value of x-sort=-1). In this case graphs will be grouped for display based on the Group By drop down value.</p>
<p><a name="concepts-aggregate-functions" /></p>
<h3 id="aggregate-functions">Aggregate functions</h3>
<p>SMG supports “aggregating” graphs for objects which have identical set of <a href="#obj-vars">variables definitions</a> using one of the currently available functions (these are available as buttons on the graphs display page):</p>
<ul>
<li><strong>GROUP</strong> - just putting the same type graphs together in a single graph</li>
<li><strong>STACK</strong> - stacking the graph lines on top of each other</li>
<li><strong>SUM</strong> - summing the same-type lines form the multiple objects together</li>
<li><strong>SUMN</strong> - same as SUM except that NaN values are treated as 0. This is mostly useful when you want to see some historical data for a sum of graphs but where some of these were created later. With SUM one would see gaps where one of the component has NaN value for the time point where SUMN will happily conver the NaNs to 0 and still display a line.</li>
<li><strong>AVG</strong> - similar to SUM but displaying graphs for the average value of the same-typed lines.</li>
<li><strong>MAX</strong> - similar to SUM but displaying graphs for the max value across the same-typed lines.</li>
<li><strong>MIN</strong> - similar to SUM but displaying graphs for the min value across the same-typed lines.</li>
</ul>
<p>By default (and when the filter results in objects from multiple remotes) SMG will do the aggregation “by remote”, i.e will produce separate aggregate images for given set of identical var-definition objects - one per remote instance. One can request a <strong>Cross-remote</strong> aggregation by selecting the respective check-box, before clicking on the aggregate function button. This works by downloading the remote rrd files locally and then producing an image from them so it is expected to be somewhat slower.</p>
<p><a name="concepts-view-objects" /></p>
<h3 id="view-objects-and-calculated-graphs">View objects and calculated graphs</h3>
<p>In addition to the mentioned RRD objects, SMG also supports <em>View objects</em>. These are defined on top of RRD objects - every View object must reference a RRD Object. Technically SMG cares only about RRD (update) objects when doing the interval runs for updates but only cares about View objects when filtering for display.</p>
<p>By default every RRD Object is also a View object so one does not need to explicitly define View objects except in some cases described below.</p>
<p><em>Note: the next paragraphs are somewhat advanced topic, feel free to skip if reading for first time and/or not familiar with rrdtool</em></p>
<p>View objects are useful to display a subset of an existing RRD object vars (lines) and/or re-order them via the <a href="#gv">gv (“graph vars”)</a> config value.</p>
<p>The other use case of View objects is that these support special <em>cdef variables</em>. rrdtool supports complex arithmetic expressions (using the available variables) to calculate plotted values. More details <a href="http://oss.oetiker.ch/rrdtool/tut/cdeftutorial.en.html">here</a>.</p>
<p>One example use case for this is varnish stats - varnishstat reports separate “requests” and “cache hit” (simple) counters. Normally one defines these as COUNTERs in rrdtool and gets an “average rate” (number/sec) when plotting/fetching csv. So we can define a special cdef variable in SMG which divides the “cache hit” rate (x 100) by the total “requests” and we effectively get an average “cache hit percentage” for the given period.</p>
<p>Check the <a href="#cdef_vars">Cdef variables</a> section for more details.</p>
<p><a name="concepts-remotes" /></p>
<h3 id="remotes">Remotes</h3>
<p>SMG was designed with multiple data centers (a.k.a. “<em>remotes</em>”) in mind from the start (this was actually one of the drivers for us to create SMG).</p>
<p>We run multiple Data Centers (DCs) at Smule. Normally one does not want to run cross-dc monitoring probes (often simply because its too slow). Also one can not expect a single monitoring instance (whether SMG, mrtg or cacti) to be able to keep up with a huge number of every-minute updates, whether across multiple data centers or within the same DC. So having one humongous monitoring instance does not work and normally people using mrtg or cacti would split the graphs across multiple instances to reduce the number of graphs each individual instance needs to keep up with. The draw-back is that one has to go to different host/url to get the relevant graphs and there is no single “namespace” where one can view graphs from multiple instance in the same UI.</p>
<p>This is where SMG <em>remotes</em> come into play. Similar to mrtg and cacti we would split the stuff we want graphed into multiple instances. Each of these instances will maintain and update its own subset of the rrd objects.</p>
<p>However in SMG one can define <em>remote</em> instances (host:port) where it is able to get the configured (RRD+View) objects in the remote instance and “merge” these into the local objects list. All remote ids are prefixed with <em>@&lt;remoteid&gt;.</em> when merged into the local object ids namespace to avoid name conflicts (the ‘@’ symbol is otherwise forbidden in object ids).</p>
<p>Then <a href="#concepts-filters">filters</a> can specify filtering within one or more specific remotes or can specify the special ’*’ (wildcard) remote id to match objects across all remotes.</p>
<p>Internally this works over remote (json-response) http APIs which expose all needed graphing and config/data retrieval operations.</p>
<p>Note that if some remote SMG node dies its graphs/data will become unavailable (i.e. at this point there is no “high availability”), it is mostly a convenience to get all monitoring in a single UI “dashboard”.</p>
<p><a name="concepts-plugins" /></p>
<h3 id="plugins">Plugins</h3>
<p>SMG supports plugins (configured in application.conf) which are just Scala classes implementing a specific interface (trait in Scala terms).</p>
<p>At a high level plugins can do a bunch of things:</p>
<ul>
<li><p>each plugin has an <em>interval</em> associated with it. Its run() method will be executed by the scheduler as needed, every <em>interval</em> seconds.</p></li>
<li><p>plugins can provide custom RRD objects implementations. For example some data may be available for graphing later - e.g. logs rotated hourly where every hour we want to graph the previous hour (now rotated) data, e.g. per minute. This does not fit in the usual SMG model of run-this-command-every-X-minutes-to-get-data-points and we have plugin(s) which can do this kind of stuff. Also, there may be some cases where you don’t even know all the objects you want to graph upfront (so that you could configure them). A custom SMG plugin can dynamically discover objects as they appear.</p></li>
<li><p>provide custom indexes - similar to custom objects, plugin can provide relevant indexes too (normally - grouping the custom plugin objects in some way which makes sense)</p></li>
<li><p>plugin can also provide arbitrary display of some relevant data (e.g. <strong>calc</strong> plugin) and also provide “object actions” to provide display of data specific to an object (e.g. the <strong>jsgraph</strong> plugin providing “Zoom” and “Historam” actions)</p></li>
<li><p>Plugin can implement monitor checks (via valueChecks method) to extend the available by default alert-[warn|crit]-[gt[e]|lt[e]|eq] options. E.g. one can check for value anomalies etc. See the mon plugin for example.</p></li>
<li><p>Plugins can implement custom dashboard items - TODO</p></li>
<li><p>Plugins can implement “internal commands” for various reasons including e.g. keeping persistent JMX connections between runs or more efficient parsing of things like OpenMetrics (Prometheus) and CSV stats,</p></li>
</ul>
<h4 id="currently-available-plugins">Currently available plugins</h4>
<ul>
<li><p>jsgraph - this plugin provides a JavaScript graphing capabilities for objects exports two actions (“Zoom” and “Histogram”). It works by using the existing API to fetch raw csv data from the rrd object(s) and using the <a href="http://plot.ly/">plot.ly</a> library to display fancier graphs client-side.</p></li>
<li><p>calc - this plugin provides ability to plot arbitrary graph from SMG object time-series by applying complex arithmetic expressions involving these time-series.</p></li>
<li><p>jmx - one can fetch JMX values using bash command wrappers which might work for longer update intervals and not too many objects but is problematic as establishing the JMX connection can be slow (and thus - expensive). It would be much better to to use persistent connections and this is what the SMG JMX plugins provides. Documentation TBD</p></li>
<li><p>mon - the “mon” (SMGMonCheckPlugin) plugin currently implements two types of value checks - anomaly detection and period-over-period check. Plugin checks are configured using the special alert-p-<em>pluginId</em>-<em>checkId</em>: “<em>conf</em>” config attribute.</p></li>
<li><p>rrdchk - being able to check and fix rrd files for cinsistency with configuration</p></li>
<li><p>scrape - a “Prometheus replacement” plugin which can generate SMG objects/configs from “scrape targets” wich are http end-points exposing metrics in specifc (OpenMetrics) format, usually at /metrics URL. Note that SMG itself exposes such /metrics end-point and the scrape plugin is enabled to process localhost:9000/metrcis by default. TODO - config reference doc.</p></li>
<li><p>autoconf - this is very similar to the scrape plugin but can support arbitrary protocols via special “templates” - essentially specifying the “type: of service being monitored. That allows monitoring using the native service protocols and nit needing prometheus”exporters". TODO - config reference doc.</p></li>
<li><p>kube - a (work-in-progress) Kubernetes monitoring plugin. It is able to auto-discover K8s nodes, end-points, services etc and metrics from that (in similar way Prometheus does that). The in-cluster services can be annotated for monitoring and these annotations are compatible with Prometheus. It can also use autoconf templates in addition to Prometheus/OpenMetrics end-points.TODO - config reference doc</p></li>
<li><p>influxdb - plugin to forward all data writes to an influxdb end-point (in batches) in format compatible with the Prometheus influxdb adapter.</p></li>
<li><p>cc - (CommonCommands) implements various commands including parsers+getters for CSV output, SNMP (snmpget) output, string transformers as more efficient replacements for using bash/cut/awk etc as external commands.</p></li>
</ul>
<p><a name="concepts-monitoring" /></p>
<h3 id="monitoring">Monitoring</h3>
<p>SMG main function is to fetch many values from various services and keep RRD databases updated using that information. Also in traditional setups one might run mrtg or cacti (or SMG) for graphing and nagios for alerting. This implies that a lot of values are fetched twice - once for nagios and once for graphing. So it makes sense to be able to define alerts based on the wealth of values SMG fetches and avoid the double-hit on the target servers.</p>
<p>The original idea for SMG monitoring was to be implemented as plugins fetching the data from the rrd files and determining whether values are within thresholds. This also allows one to check data at arbitrary (as available in the RRD files) resolution for desired periods.</p>
<p>Unfortunately there is one significant issue with that approach - it is too heavy to apply on all objects (based on experience it can almost half the number of objects SMG is capable to update every minute on given hardware).</p>
<p>This is not acceptable so now (as of v0.2) SMG has built-in monitoring based on a “live” (in memory) data feed consisting of all the values fetched for RRD updates. One can define alerts (acceptable values/ranges) in SMG as part of the object variables configurations or as part of indexes (including “hidden” indexes which sole current purpose is to define alerts).</p>
<p>The <a href="/monitor">monitoring page</a> page displays all (local or remote) current problems (anything with non-OK state). SMG supports the following states, sorted by severity:</p>
<ul>
<li><p><strong>OK</strong> - The normal state - a valid value was retrieved and updated in the RRD.</p></li>
<li><p><strong>ANOMALY</strong> - Currently there are two types of anomalies, the first is a “counter overflow”, e.g. a 32 bit counter passes 2^32 (or was reset) resulting in NaN value and the second one is a “spike” or “drop” - read the notes below for more details on <a href="#concepts-anomaly">anomaly detection</a>.</p></li>
<li><p><strong>WARNING</strong> - A retrieved value matched against some defined “warning” threshold.</p></li>
<li><p><strong>FAILED</strong> - A data retrieval failed - the external command (pre-)fetching data failed. This can happen for various reasons including target host or service down.</p></li>
<li><p><strong>CRITICAL</strong> - A fetched value matched against some defined “critical” threshold.</p></li>
<li><p><strong>SMGERR</strong> - global SMG error. Usually - overlapping runs (or SMG bug).</p></li>
</ul>
<p>Check <a href="#monitoring">monitoring configuration</a> for more details on how the thresholds are defined in the yaml configuration.</p>
<p>These states come in two flavors - “<strong>HARD</strong>” (at least consecutive 3 non-ok states) and “<strong>SOFT</strong>” (less than 3 consecutive non-ok states). The OK state is always HARD. These concepts are borrowed from nagios.</p>
<p>On shut-down all the in-memory state for monitoring is saved to json files (in the directory specified by the <strong>$monstate_dir</strong> global config value) and loaded on start-up.</p>
<p>SMG also supports “silencing” alerts which is basically hiding them from the error page and preventing alert notifications. There are two types of silencing:</p>
<ul>
<li><p><strong>Acknowledge</strong> - this will “silence” a current error until it gets back into a normal state which will automatically clear the acknowledgement.</p></li>
<li><p><strong>Silence for</strong> - silence some error for given time period after which the silencing will expire. Silencing does not clear on recovery which is different than acknowledgement and is useful when one wants to prevent alerts upfront when some host or service has planned maintenance and downtime and also for services which are in “flapping” state - flipping between OK and non-OK states (otherwise acknowlegement is better).</p></li>
<li><p><strong>Sticky silencing</strong> - this allows one to define regex (and regex exlude) filters which will silence all matching objects but also matching ones defined in the future (until the silencing period expires). This function is available as a check-box in the Monitor - State trees page described below.</p></li>
</ul>
<p>By default SMG will not show Soft, Acknowledged or Silenced errors in the Monitor page - this can be toggled for each type using the respective checkboxes.</p>
<p>In addition to current error states SMG keeps track of recent error events on the Monitor - <a href="/monitor/log">Event log</a> page. Internally these are stored in log files under the directory speciified by the <strong>$monlog_dir</strong> global config value.</p>
<p>One can browse the current SMG state trees (built based on the Run trees mentioned above) in the Monitor - <a href="/monitor/trees">State trees</a> page. This page allows easy upfront silencing of mutltiple hosts/services when these have maintenance/downtime pending. This is also where the Sticky silencing check-box is available.</p>
<p>All currently silenced states and also currently active Sticky silences can be seen in the Monitor - <a href="/monitor/silenced">Silenced states</a> page. This page useful to explicitly un-silence objects and remove active Sticky silences before the silencing period has expired.</p>
<p>Ths Monitor - <a href="/monitor/runtree">Run trees</a> page display the entire internal SMG Run trees (per-interval) structure. Useful to troubleshoot config issues and sanity checking what SMG does on every interval run.</p>
<p>There is also a <a href="/monitor/heatmap">heatmaps page</a> available where one can see a graphical representation of the overal systems health (work in progress and subject to change).</p>
<p><a name="concepts-anomaly"></p>
<h4 id="anomaly-detection-via-the-mon-check-plugin">Anomaly detection (via the “mon” check plugin)</h4>
<p>The SMG Mon check plugin anomaly detection works based on a “threshold for difference” (default = 1.5) and two time periods - shorter (default 30 minutes) and longer (default - 30 hours). Will use the default values in the examples below.</p>
<p>First, for any value which has a “spike check” configuration (“alert-p-mon-anom”) enabled SMG will start keeping in-memory stats about the most recent values. The number of stats that will be kept depends on the object interval compared to the configured check periods - e.g. for a graph updated every minute, 30 minutes would map to 30 data points and 30h to - 1800. SMG keeps the short period values (30 in the example) at full granularity. For the long period data instead of keeping all individual 1800 values SMG will group them in overlapping chunks each with the size of the short period or each chunk will cover 30 minutes. How that works is that internally SMG keeps up to half-short period (30 / 2 = 15) values more at full granularity (in addition to the 30 short-term ones) named “previous short term” values. Whenever that list size increases to half the short-period, its values are combined with the first half of the short-period values (for a full short-period sized chunk) and SMG will add an aggregate value to the “long term” stats list before truncating the “previous short term” list to empty (and also throwing away a long term stat if above max size). The actual aggregation consist of calculating the following stats for the chunk:</p>
<ul>
<li>average - the average value - sum(values) / count(values)</li>
<li><a href="http://www.mathsisfun.com/data/standard-deviation.html">variance</a> - this is a “population variance”</li>
<li>90 percentile value - the max value after throwing away the top 10% values</li>
<li>count - how many data points were used to calculate the above stats (useful to know when the threshold/periods change).</li>
</ul>
<p>So in our example SMG would keep between 30 and 45 data points at max granularity and an up to 120 data points for the long period.</p>
<p>The second part is the actual check logic. This is still somewhat work in progress but at a high level the logic is based on chunks stats “similarity”. So when checking for alert SMG will calculate the same chunk stats from the short-term stats and the previous short-term stats. Then it will compare the calculated short-term chunk stats with all of the long term period stats. If any of the short-term stats average, varinace or 90%-ile values are within 1.5 (the mentioned “difference” threshold) times difference (more or less) from the compared long term stat then the two stats are “similar” and SMG will rule out the possibility that there is an anomaly (it has “seen” similar values already).</p>
<p>There are some additional checks to see whether it is a spike or drop but overall the approach is to focus on finding patterns proving that the current state is NOT an anomaly.</p>
<p><a name="config" /></p>
<h2 id="configuration-reference">Configuration Reference</h2>
<p>SMG uses <a href="http://yaml.org/">yaml</a> for its configuration file format. Yaml is flexible and it is both easy to read and write.</p>
<p>By default SMG will look for a file named <strong>/etc/smg/config.yml</strong> and read its configuration from there. That file name can be changed in the <em>conf/application.conf</em> file inside the SMG installation dir, if desired.</p>
<p>All config items are defined as a list. I.e. the top-level yaml structure for a config file must be a list (SMG will fail to parse it otherwise). This basically means that every object definition starts with a dash at the beggining of a line, e.g.:</p>
<pre>
...
- $rrd_dir: smgrrd
- some.rrd.object:
  ...
- ^some.index.object:
  ...
...
</pre>
<p>Note that ordering matters in general - SMG will try to preserve the order of the graphs to be displayed to match the order in which the objects were defined.</p>
<p><a name="config-toc" /></p>
<h4 id="configuration-reference---toc">Configuration Reference - TOC</h4>
<ol type="1">
<li><a href="#globals">Globals</a>
<ol type="1">
<li><a href="#pre_fetch">Pre-fetch</a></li>
<li><a href="#interval_def">Interval thread pools</a></li>
</ol></li>
<li><a href="#rrd-objects">RRD objects</a></li>
<li><a href="#rrd-agg-objects">Aggregate RRD objects</a></li>
<li><a href="#view-objects">View objects</a></li>
<li><a href="#indexes">Indexes</a></li>
<li><a href="#hindexes">Hidden Indexes</a></li>
<li><a href="#cdash">Custom dashboards configuration</a></li>
<li><a href="#monitoring">Monitoring configuration</a></li>
<li><a href="#plugins-conf">Bundled Plugins configuration</a></li>
</ol>
<p><a name="globals" /></p>
<h3 id="globals">Globals</h3>
<p>Global for SMG variables are defined as a name -&gt; value pairs where the name is prefixed with ‘$’ sign. Here is the list of supported global variables, together with their default values (all of these are optional):</p>
<ul>
<li><p><strong>$rrd_dir</strong>: <em>“smgrrd”</em> - directory where to store your rrd files. You probably want to change this on any production installation (for more demanding setups, may want to put that dir on an SSD drive). That dir must be writabe by the SMG user. This must be defined before object definitions in the config.</p></li>
<li><p><strong>$rrd_dir_levels</strong>: <em>None</em> - if set, it has to be a list of numbers separated with ‘:’ symbol (e.g. “1:1”). In that case SMG will create and use sub-dir levels under rrd_dir (one level per list item) using the MD5 hash value of the object id and respective number of bytes (for each level) from that hash as hex strings. Useful if want to keep track of hundreds of thousands of rrds where having them all in one dir could be a problem on some systems. Only set this once (attempt to set it second time in the config will be ignored). WARNING: Never change the value once you have rrds created, you will lose the data if you do so.</p></li>
<li><p><strong>$dash-default-cols</strong>: <em>6</em> - How many “columns” of graphs to display on the dashboard by default. SMG will insert a new line between graphs at that “column”.</p></li>
<li><p><strong>$dash-default-rows</strong>: <em>10</em> - How many “rows” of graphs to display on the dashboard by default. This together with the number of “columns” determines the “page size” - how many graphs will be displayed on each graphs page.</p></li>
<li><p><strong>$auto-refresh-interval</strong>: <em>300</em> - page auto refresh interval (if enabled by default or via the UI). Set to 0 to completely disable auto-refresh.</p></li>
<li><p><strong>$default-auto-refresh</strong>: <em>true</em> - whether by default dashboard pages will reload automatically. This can be toggled on per page basis in the UI.</p></li>
<li><p><strong>$default-interval</strong> - <em>60</em> - default update interval for objects not specifying it. This must be defined in the config before object definitions lacking interval setting (and one can specify it multiple times, changing the value for subequently defined objects) if one wants to change it from the default.</p></li>
<li><p><strong>$default-timeout</strong> - <em>30</em> - default timeout for object fetch commands (when retrieving data for updates) not specifying it. This must be defined in the config before object definitions lacking interval setting (and one can specify it multiple times, changing the value for subequently defined objects) if one wants to change it from the default.</p></li>
</ul>
<p><a name="img_dir" /></p>
<ul>
<li><p><strong>$img_dir</strong>: <em>“public/smg”</em> - where to output the graphed images. That dir must be writabe by the SMG user.</p></li>
<li><p><strong>$url_prefix</strong>: <em>“/assets/smg”</em> - what is the base url path under which the image files will be accessible by the browser</p></li>
<li><p><strong>$rrd_cache_dir</strong>: <em>“smgrrd”</em> - sometimes (when wanting to graph an image from multiple rrd files residing on diff remotes) SMG needs to download the actual rrd files locally. These rrd files are stored under the $rrd_cache_dir value. That dir must be writabe by the SMG user.</p></li>
<li><p><strong>$rrd_tool</strong>: <em>rrdtool</em> - the rrdtool command to use. Can specify full path if the version of rrdtool you want to use is not on the default PATH.</p></li>
</ul>
<p><a name="rrd_socket" /></p>
<ul>
<li><p><strong>$rrd_socket</strong>: - <em>(default is None)</em>. Otherwise one can specify a string value like unix:/path/to/socket.file. If specified it will be passed to the relevant rrdtool update, graph or fetch commands with the –daemon unix:/path/to/socket.file option. This in turn is intended for use with rrdcached (a rrdtool daemon used for doing updates more efficiently). rrdcached is highly recommended on more demanding setups.</p></li>
<li><p><strong>$rrdcached_update_batch_size</strong>: - <em>1</em> - if set to more than 1 and $rrd_socket is specified SMG will batch updates (with batch size of the value) and use socat and rrdcached protocol directly for even more efficient updates.</p></li>
<li><p><strong>$rrdcached_socat_command</strong>: - <em>socat</em> - the socat command to use when flushing batched writes. By default SMG will use <em>socat</em> and expect it to be in the executables PATH.</p></li>
<li><p><strong>$rrdcached_flush_all_on_run</strong>: - <em>false</em> - whether to send FLUSHALL to rrdcached at the end of every run (only used when doing batched updates via rrdcached protocol)</p></li>
<li><p><strong>$rrdcached_flush_on_read</strong>: - <em>true</em> - whether to send FLUSH <em>file</em> to rrdcached before every read - fetch or graph (only used when doing batched updates via rrdcached protocol). Either this or $rrdcached_flush_all_on_run should be set to true in rrdcached batch update mode. Setting both to true can hurt efficiency and setting both to false would result in retrieving possibly stale data.</p></li>
<li><p><strong>$rrd_graph_width</strong>: <em>607</em> - the graph width passed to rrdtool when graphing</p></li>
<li><p><strong>$rrd_graph_height</strong>: <em>152</em> - the graph height passed to rrdtool when graphing</p></li>
<li><p><strong>$rrd_graph_font</strong>: <em>“DEFAULT:0:monospace”</em> - the graph font string passed to rrdtool when graphing</p></li>
<li><p><strong>$rrd_graph_dppp</strong>: <em>3</em> <em>(advanced)</em> - how many data points are represented in a singe “width” pixel. Used to estimate displayed graph resolution (step)</p></li>
<li><p><strong>$rrd_graph_dppi</strong>: <em>None</em> <em>(advanced)</em> - how many data points can be represented in a singe image. If this is set <strong>$rrd_graph_dppp</strong> is ignored. Used to estimate displayed graph resolution/step</p></li>
<li><p><strong>$rrd_graph_padding</strong>: <em>83</em> <em>(advanced)</em> - the padding (in pixels) rrdtool adds to the configured <strong>$rrd_graph_width</strong> for the resulting image size. Used to estimate html cell widths.</p></li>
<li><p><strong>$rrd_max_args_len</strong>: <em>25000</em> <em>(advanced)</em> - The maximum length of a rrdtool command. If a resulting command exceeds that the rrdtool arguments will be passed via stdin instead of command-line args as it is by default.</p></li>
<li><p><strong>$monlog_dir</strong>: <em>“monlog”</em> - the directory where the monitoring system saves logs with events in json format (one file per calendar date).</p></li>
<li><p><strong>$monstate_dir</strong>: <em>“monstate”</em> - the directory where the monitoring system saves its memory state on shut down.</p></li>
<li><p><strong>$include</strong>: <em>(no default value)</em> “path/to/some/*.yml” - whenever the SMG config parser encounters an $include global it will interpret its value as a filesystem “glob” (and possibly expand that to multiple files) and then process each of the files yielded from the glob as regular config files (these can have more $includes too)</p></li>
<li><p><strong>$search-max-levels</strong>: <em>10</em> - how many levels (of dotted tokens) to support in autocomplete. Lower to 2-3 or less if you run a cluster with hundreds of thousands of objects.</p></li>
</ul>
<p><a name="index-tree-levels"></p>
<ul>
<li><strong>$index-tree-levels</strong>: <em>1</em> - How many levels of indexes to display by default on the Configured Indexes page. The default value of 1 means to display only top level indexes, 2 would also display their children etc. Valid values are between 1 and 5.</li>
</ul>
<p><a name="run-tree-levels"></p>
<ul>
<li><p><strong>$run-tree-levels-display</strong>: <em>1</em> - Same as $index-tree-levels but applies to monitor state run trees. How many levels of fetch commands to display by default on the top level Run trees page.</p></li>
<li><p><strong>$max-url-size</strong>: <em>8000</em> - The maximum url size supported by browsers. SMG will use POST requests (instead of GET) if a filter URL would exceed that size. Only draw back is that the resulting URLs will not be shareable. This needs to be set to around 2000 for IE support, and can be raised to 32k if one does not care about Android and IE.</p></li>
</ul>
<p><a name="remote" /></p>
<ul>
<li><strong>$remote</strong>: similar to $pre_fetch $remote is special and is not a simple name -&gt; value pair. A $remote defines an unique remote <strong>id</strong> and an <strong>url</strong> at which the remote SMG instance is accessible. Here is an example remote definition:</li>
</ul>
<blockquote>
<pre>
- $remote:
  id: another-dc
  url: "http://smg.dc2.company.com:9080"
# slave_id: dc1
# graph_timeout_ms: 30000
# config_fetch_timeout_ms: 300000
</pre>
</blockquote>
<blockquote>
<p>If the optional <strong>slave_id</strong> parameter is provided it indicates that this instance is a “worker” in the context of that remote. Its value must be the id under this instance is configured on the “master”. A slave instance will not load and display the relevant remote instance config and graphs but will only notify it on its own config changes.</p>
</blockquote>
<blockquote>
<p>One can run a setup where the “main” instance (can be two of them, for redundancy) has multiple remotes configured where the remote instances only have the “main” one as configured (for them) remote (with slave_id set). With such setup one only needs a single “beefy” (more mem) “main” instance which will hold all available across the remotes objects and the other ones will only keep theirs.</p>
</blockquote>
<blockquote>
<p>The <strong>graph_timeout_ms</strong> and <strong>config_fetch_timeout_ms</strong> values allow one to override the global timeouts for garph/monitor state API calls and config fetch (which can be much slower)</p>
</blockquote>
<ul>
<li><p><strong>$remote-graph-timeout-ms</strong>: 30000 (30 sec) - default timeout when requesting graphs (and monitor states) from remote instances. Can be overridon in each remote definition.</p></li>
<li><p><strong>$remote-config-fetch-timeout-ms</strong>: 300000 (5 min) - default imeout when fetching remote config. These can be big so normally thats much higher than the graph timeout value.</p></li>
<li><p><strong>$reload-slave-remotes</strong>: <em>“false”</em> - By default SMG will only notify “master” remote instances (ones defined with slave_id property). One can override this behavior and make it notify slave instances too by setting this to “true”.</p></li>
<li><p><strong>$proxy-disable</strong>: <em>“false”</em> - by default SMG will link to remote images via its /proxy/&lt;remote-id&gt;/&lt;path-to-image&gt;.png URL which in turn will proxy the request to the actual remote SMG instance. This behavior can be disabled by setting the $proxy-disable value to “true”. In that case the end-user will need direct access to the respective remote instances.</p></li>
</ul>
<blockquote>
<p>Note that in production setups where there is already a reverse proxy serving the static images directly it is recommended to keep $proxy-disable to “false” (same as omitting it) and then to intercept the /proxy/&lt;remote-id&gt; URLs at the reverse proxy and proxy these directly to the respective SMG instances (at their root URL) instead of hitting the local SMG one for proxying. Here is how an example reverse proxy configuration for apache could look like for a remote named “<em>some-dc</em>” where SMG is running on <em>smg1.some-dc.myorg.com</em> and listening on port 9080 (possibly another reverse proxy there):</p>
</blockquote>
<blockquote>
<pre>
        ProxyPass        /proxy/some-dc  http://smg1.some-dc.myorg.com:9080/
        ProxyPassReverse /proxy/some-dc  http://smg1.some-dc.myorg.com:9080/
</pre>
</blockquote>
<blockquote>
<p>Check the <a href="#running">Running and troubleshooting</a> section for more details on reverse proxy setup in production.</p>
</blockquote>
<ul>
<li><strong>$proxy-timeout</strong>: <em>30000</em> - this option can be used to adjust the proxy requests timeout (when these are handled by SMG and not the reverse proxy in front).</li>
</ul>
<p><a name="rra_def" /></p>
<ul>
<li><strong>$rra_def</strong>: - this is another global definition which represents an object instead of simple name -&gt; value pair. Whenever rrdtool creates a new rrd file it must get a set of definitions for Round Robin Archives ( RRAs, explained better <a href="http://oss.oetiker.ch/rrdtool/tut/rrd-beginners.en.html">here</a> ). A $rra_def has an <strong>id</strong> and a list of RRA definitions under the <strong>rra</strong> key. The actual RRA definitions are strings and defined using rrdtool syntax. Here is how the default SMG RRA for 1 minute interval would look like if defined as $rra_def:</li>
</ul>
<blockquote>
<pre>
- $rra_def:
  id: smg_1m
  rra:
    - "RRA:AVERAGE:0.5:1:5760"
    - "RRA:AVERAGE:0.5:5:1152"
    - "RRA:AVERAGE:0.5:30:1344"
    - "RRA:AVERAGE:0.5:120:1440"
    - "RRA:AVERAGE:0.5:360:5840"
    - "RRA:AVERAGE:0.5:1440:1590"
    - "RRA:MAX:0.5:1:5760"
    - "RRA:MAX:0.5:5:1152"
    - "RRA:MAX:0.5:30:1344"
    - "RRA:MAX:0.5:120:1440"
    - "RRA:MAX:0.5:360:5840"
    - "RRA:MAX:0.5:1440:1590"
</pre>
</blockquote>
<blockquote>
<p>Note that normally one does not need to define or use any $rra_def objects, the defaults which SMG will pick would work just fine for most of the cases (these have been inspired by mrtg/cacti). Still there are some use cases where one wants to use different RRAs - e.g. keep some important graphs at higher resolutions for longer period (the draw-back being a bigger RRD file size).</p>
</blockquote>
<p><a name="notify-command"></p>
<ul>
<li><strong>$notify-command</strong> - this defines a named command object to be executed for delivery of alert notifications (can have many of those). The command id can then be referenced as “recipient” in notify-{crit/warn/spike} object/index or global definitions. Example $notify-command definitions, together with globals referencing them:</li>
</ul>
<blockquote>
<pre>
- $notify-command:
  id: mail-people
  command: "smgscripts/notif-mail.sh 'asen@smule.com somebodyelse@smule.com' "
- $notify-command:
  id: pagerduty
  command: "smgscripts/notif-pagerduty.sh"
- $notify-crit: mail-people,pagerduty
- $notify-warn: mail-people
</pre>
</blockquote>
<blockquote>
<p>The actual command gets executed with the following variables set by SMG in the child process environment:</p>
</blockquote>
<blockquote>
<ul>
<li>$SMG_ALERT_SEVERITY - one of RECOVERY, ACKNOWLEDGEMENT, ANOMALY, WARNING, FAILED, CRITICAL, SMGERR, THROTTLED, UNTHROTTLED</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>$SMG_ALERT_KEY - the affected object/var, pre-fetch or global issue identification string.</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>$SMG_ALERT_SUBJECT - the “subject” for the message to be sent</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>$SMG_ALERT_BODY - the “body” of the message to be sent</li>
</ul>
</blockquote>
<blockquote>
<p>Check smgscripts/notif-mail.sh for an example of how this could work</p>
</blockquote>
<ul>
<li><p><strong>$notify-global</strong>: a comma separated list of $notify-command ids, to be executed on any global SMG errors (usually - overlaps)</p></li>
<li><p><strong>$notify-crit</strong>: a comma separated list of $notify-command ids, to be executed on any (global or object-specific) critical errors</p></li>
<li><p><strong>$notify-fail</strong>: a comma separated list of $notify-command ids, to be executed on any (global or object-specific) “failed” (i.e. fetch command failure) errors</p></li>
<li><p><strong>$notify-warn</strong>: a comma separated list of $notify-command ids, to be executed on any (global or object-specific) warning errors</p></li>
<li><p><strong>$notify-anom</strong>: a comma separated list of $notify-command ids, to be executed on any anomaly (spike/drop) errors. Be warned that this can get noisy on large setups.</p></li>
<li><p><strong>$notify-baseurl</strong>: Base url to be used in alert notifications links, default is http://localhost:9000 (so you probaly want that set if you intend to use alert notifications). This can also be pointed to a different (master) SMG instance URL where the current one is configured. Set <strong>$notify-remote</strong> to be the id of the current instance as defined in the master config in that case.</p></li>
<li><p><strong>$notify-remote</strong>: See $notify-baseurl above, default is none/local.</p></li>
<li><p><strong>$notify-backoff</strong>: set the default “backoff” period or the interval at which non-recovered issues alerts are re-sent. Default is “6h”.</p></li>
<li><p><strong>$notify-throttle-count</strong>: Alert notifications support throttling, you can set the max messages sent during given interval. This sets the max messages (count) value. The default when not present is Int.MaxValue which effectively disables throttling.</p></li>
<li><p><strong>$notify-throttle-interval</strong>: Alert notifications support throttling, you can set the max messages sent during given interval (in seconds). This sets the interval (default is 3600 or 1h).</p></li>
<li><p><strong>$notify-strikes</strong>: (default: <em>3</em>) - how many consecutive error states to be considered a hard error and in turn - trigger alert notifications.</p></li>
<li><p><strong>$cdash</strong>: Defining a custom dashboard. Check for details <a href="#cdash">below</a></p></li>
</ul>
<p><a name="pre_fetch" /></p>
<ul>
<li><strong>$pre_fetch</strong>: pre_fetch is special and it is not a simple name -&gt; value pair. A $pre_fetch defines an unique <strong>id</strong> and a <strong>command</strong> to execute, together with an optional <strong>timeout</strong> for the command (30 seconds by default) and an optional “parent” pre_fetch id. If a <strong>pass_data</strong> property is defined and is set to true the stdout of the command will be passed to all child commands as stdin. By default SMG will use the timestamp of the top-level pre-fetch for RRD updates. One can set the <strong>ignorets</strong> property to ignore the timstamp of the pre-fetch and use the first child timestamp which doesn’t have that property. In addition pre_fetch can have a <strong>child_conc</strong> property (default 1 if not specified) which determines how many threads can execute this pre-fetch child pre-fetches (but not object commands which are always parallelized). One can also specify a <strong>delay</strong> expressed as a floating point value in seconds. This will cause the command (and it children) to be executed with a delay according to the specified number of seconds. If a negative delay is specified the command will be run with a random delay between 0 and (interval - abs(delay)) seconds. Pre fetch also supports <strong>notify-fail</strong> - to override alert recipients for failure and also <strong>notify-disable</strong>, <strong>notify-backoff</strong> etc. (check <a href="#monitoring">monitoring config</a> for details). Here are two example pre_fetch definitions, one referencing the other as a parent:</li>
</ul>
<blockquote>
<pre>

    - $pre_fetch:
      desc: "check if localhost is up"
      id: host.host1.up
      command: "ping -c 1 host1 >/dev/null"
      notify-fail: mail-asen, notif-pd
      child_conc: 2
      ignorets: true
      timeout: 5

    - $pre_fetch:
      id: host.host1.snmp.vals
      command: "snmp_get.sh o1 laLoad.1 laLoad.2 ssCpuRawUser.0 ssCpuRawNice.0 ..."
      pre_fetch: host.host1.up
      pass_data: true
      timeout: 30
      delay: 5.5

Alternate (new) syntax:

    - type: pre_fetch
      desc: "check if localhost is up"
      id: host.host1.up
      command: "ping -c 1 host1 >/dev/null"
      notify-fail: mail-asen, notif-pd
      child_conc: 2
      ignorets: true
      timeout: 5

    - type: pre_fetch
      id: host.host1.snmp.vals
      command: "snmp_get.sh o1 laLoad.1 laLoad.2 ssCpuRawUser.0 ssCpuRawNice.0 ..."
      pre_fetch: host.host1.up
      pass_data: true
      timeout: 30
      delay: 5.5

</pre>
</blockquote>
<blockquote>
<p>As explained in the <a href="#concepts-pre_fetch">concepts overview</a> SMG RRD objects can specify a pre_fetch command to execute before their own command gets executed (for the current interval run). That way multiple objects can be updated from given source (e.g. host/service) while hitting it only once per interval. Pre_fetch itself can have another pre_fetch defined as a parent and one can form command trees to be run top-to-bottom (stopping on failure).</p>
</blockquote>
<blockquote>
<p>Note that the “run tree” defined in this way must not have cycles which can be created in theory by circularly pointing pre_fetch parents to each other (possibly via other ones). Currently SMG will reject the config update if circular parent depenencies in the run-tree are detected (detection is simply having a hard limit of max 10 parent levels when constructing the run trees).</p>
</blockquote>
<p><a name="rrd-objects" /></p>
<p><a name="interval_def" /></p>
<ul>
<li><strong>$interval_def</strong>: similar to pre_fetch interval_def is special and it is not a simple name -&gt; value pair. It has a mandatory <strong>interval</strong> property specifying the interval (in seconds) for which this applies and optional <strong>threads</strong> property specifying max number of threads (default is 4 and if set to 0 it will be dynamically set to the number of cpu cores available) and and a <strong>pool</strong> property specifying the type of thread pool - one of FIXED (default) and WORK_STEALING. Examples:</li>
</ul>
<blockquote>
<pre>

    - $interval_def:
      interval: 60
      threads: 20
      pool: FIXED

    - $interval_def:
      interval: 200
      threads: 4
      pool: WORK_STEALING

Alternate (new) syntax:

    - type: interval_def:
      interval: 60
      threads: 20
      pool: FIXED

    - type: interval_def:
      interval: 200
      threads: 0 # will use num cpu cores
      pool: WORK_STEALING

</pre>
</blockquote>
<h3 id="rrd-objects-1">RRD objects</h3>
<p>RRD objects usually represent the majority of the SMG config. These define a rrd file to be updated, its structure, the interval on which we want to update it and the command to use to retrieve the values to update. A rrd object is represented by a yaml structure which could look like this:</p>
<pre>
- id: host.localhost.sysload                            # rrd object id
  command: "smgscripts/mac_localhost_sysload.sh"        # mandatory command outputting values
  timeout: 30                                           # optional - fetch command timeout, default 30
  title: "Localhost sysload (1/5/15 min)"               # optional title - object id will be used if no title is present
  interval: 60                                          # optional - default is 60
  data_delay: 0                                          # optional - default 0
  delay: 0.0                                            # optional - default 0.0
  rrd_type: GAUGE                                       # optional - default is GAUGE. Can be COUNTER etc (check rrdtool docs)
  rrd_init_source: "/path/to/existing/file.rrd"         # optional - if defined SMG will pass --source <val> to rrdtool create
  stack: false                                          # optional - stack graph lines if true, default - false
  pre_fetch: some_pf_id                                 # optional - specify pre_fetch command id.
  notify-fail: mail-asen,notif-pd                       # optional - sent command failures to these recipients (see notify- conf below)
  labels:                                               # optional - arbitrary map of key/valu labels, useful for filtering
    foo: bar                                            #            and grouping by
  vars:                                                 # mandatory list of all variables to graph
    - label: sl1min                                     # the variable label.
      min: 0                                            # optional - min accepted rrd value, default 0
      max: 1000                                         # optional - max accepted rrd value, default U (unlimmited)
      maxy: 1005                                        # optional - use this te set upper limit on the displayed graph (similar to maxy index option)
      mu: "lavg"                                        # optional - measurement units, default - empty string
      lt: "LINE1"                                       # optional - line type, default is LINE1
      alert-warn-gt: 8                                  # optional - monitoring thresholds, details below
    - label: sl5min                                     # another variable def
    - label: sl15min                                    # a 3d variable def
</pre>
<p>Most properties are optional except:</p>
<ul>
<li><p><strong>object id</strong> - in the old syntax that would be the key after the dash defining the start of the object, <em>host.localhost.sysload</em> in the example. The new syntax explicitly sets the id key/value. It must be unique for the local SMG instance and consist only of alpha-numeric characters and the ‘_’, ‘-’ and ‘.’ symbols. By convention, ids should be defined like <strong>&lt;class&gt;.&lt;subclass&gt;[.&lt;subclass&gt;...].&lt;object&gt;</strong>, e.g. <em>host.o1.cpu</em> or <em>host.o1.diskused.var</em>. Following that convention is not enforced by SMG but using it helps it discover “automatic indexes” and also makes it much easier to write <a href="#indexes">index (filter) definitions</a> and in general - navigate around SMG.</p></li>
<li><p><strong>command</strong>: is a mandatory property and its value must be a system command (string) which (retrieves and) outputs the numeric values we want tracked, each on a separate line. Note that SMG only cares about the first N lines of the output (where N is the number of vars, see below) from the script and will ignore excess lines (this is for compatibility with mrtg scripts which output uptime and hostname after values). If the command ouptuts less lines than expected or these are not numeric values, an error will be generated and NaN values will be recorded in the RRD file time series.</p></li>
</ul>
<p><a name="obj-vars"></p>
<ul>
<li><p><strong>vars</strong>: - mandatory list of yaml objects (string -&gt; string maps). The number and order of var objects determines the rrd structure and how many lines of output from the external <em>command</em> will be considered. Each var itself supports the following properties where only label is mandatory (technically - even label is not mandatory but at least one key -&gt; value must be present):</p>
<ul>
<li><p><strong>label</strong>: - the label to use for this variable in the graph legend</p></li>
<li><p><strong>mu</strong>: (“measurement units”) - what string to display after the number (avg/max etc) values in the graph legend, e.g. “bps” (for bits per secod). rrdtool (and thus SMG) will automatically use scale modifiers like M (for mega-), m (for milli-) etc. so bps would become Mbps for megabits per second.</p></li>
<li><p><strong>min</strong>: (default <em>0</em>) - minimal accepted rrd value. Values below that will be ignored and NaN will be recorded. Set to <em>U</em> if you want to record negatve values.</p></li>
<li><p><strong>max</strong>: (default <em>U</em> for unlimited) - maximal accepted rrd value. Values above that will be ignored and NaN will be recorded instead. This is rarely needed for GAUGE type graphs but is almost <strong>always</strong> needed for COUNTER graphs. rrdtool will use the max value to detect counter overflows where the delta is usually resulting in a huge integer (if unsigned, otherwise - negative) value. If that value is above the max rrdtool will ignore it and record a NaN. Use the DERIVE type (with the default min=0) to always ignore counter overflows (negative values).</p></li>
<li><p><strong>maxy</strong>: (default <em>None</em> - auto scaling) - set the upper limit on the displayed graph.</p></li>
<li><p><strong>lt</strong>: (line type, default is <em>LINE1</em>) - the line type to use when graphing. Check rrdtool documentation for supported line types (e.g. AREA etc).</p></li>
</ul>
<p><a name="obj-vars-cdef"></p>
<ul>
<li><p><strong>cdef</strong>: - one can provide a rrdtool cdef / <a href="http://oss.oetiker.ch/rrdtool/tut/rpntutorial.en.html">RPN expression</a> and SMG would graph the result of that expression instead of the original value. Inside the expression the actual rrd value can be referenced using the special ‘<em>$ds</em>’ string. For example to multiply the actual RRD value by 8 before graphing one would use the following cdef value: _"$ds,8,*"_. This specific example is useful when graphing network traffic counters which are reported in bytes but we prefer to have them graphed in bits (per second)</p></li>
<li><p><strong>alert-*</strong>: - these are multiple properties which define monitoring alert thresholds (e.g. alert-wart-gt, alert-crit-lt, etc.) check <a href="#monitoring">monitoring config</a> for details.</p></li>
<li><p><strong>notify-*</strong>: - these are multiple properties which define monitoring alert notifications. Check <a href="#monitoring">monitoring config</a> for details.</p></li>
</ul></li>
</ul>
<p>Note that changing the number of vars when the rrd object already exists is not supported and will cause update errors, and changing their order will result in messed up data. It is still possible to make such a change outside SMG using rrdtool though.</p>
<p>The following properties are all optional.</p>
<ul>
<li><p><strong>interval</strong>: - (default - <em>60</em> seconds) - every rrd object has a an interval associated with it - determining how often the data will be retrieved from the monitored service and updated in the RRD file.</p></li>
<li><p><strong>data_delay</strong> - (default - <em>0</em> seconds) - sometimes services report their data with certain delay (e.g. a CDN API may report the traffic used with 15 min delay). Set that value to the number of seconds data is delayed with and on update SMG will subtract that many seconds from the fetch/update timestamp. This was named <strong>dataDelay</strong> in older versions.</p></li>
<li><p><strong>delay</strong> - (default - <em>0.0</em> seconds) - If an object has a delay specified its fetch command will not run immediately when its turn comes but after the specified amount of seconds. If a negative delay is specified the command will be run with a random delay between 0 and (interval - abs(delay)) seconds.</p></li>
<li><p><strong>title</strong>: - free form text description of the object. If not specified, the object id will be used as a title.</p></li>
<li><p><strong>rrd_type</strong>: (default - GAUGE) - can be COUNTER, DERIVE etc, check rrdtool docs for other options. Note that originally SMG used rrdType for this property which is inconsistent with the rest. SMG will still try to read rrdType if rrd_type is not present, for backwards compatibility.</p></li>
<li><p><strong>rrd_init_source</strong>: (no default) - if defined SMG will pass –source <em>val</em> to rrdtool create. This can be used to rebuild some rrd using different step/RRAs etc. E.g. update the conf specifying rrd_init_source: object.id.old, then rename the actual rrd file from object.id.rrd to object.id.old. On the next run SMG will re-create the rrd using the newly specified config and populate the data from the pre-existing values. Check rrdtool docs for more information and caveats (Note: this feature requires recent rrdtool version supporting the –source option, 1.5.5+ is known to work)</p></li>
<li><p><strong>stack</strong>: (default - false) - if set to true - stack graph lines on top of each other.</p></li>
<li><p><strong>pre_fetch</strong>: (default - None) - specify a <a href="#pre_fetch">$pre_fetch</a> command id to execute before this object command will be run.</p></li>
<li><p><strong>rra</strong>: (default - None) - specify a <a href="#rra_def">$rra_def id</a> to use for this object. By default SMG will pick one based on object interval.</p></li>
<li><p><strong>notify-xxx</strong>: - these are multiple properties which define monitoring alert notifications. Check <a href="#monitoring">monitoring config</a> for details. Note that from the per-leve specifiers only notify-fail is relevant at this level.</p></li>
<li><p><strong>labels</strong>: (default - empty map) - a map of key/vaule pairs useful for filtering and grouping by.</p></li>
</ul>
<p><a name="rrd-agg-objects" /></p>
<h3 id="aggrgegate-rrd-objects">Aggrgegate RRD objects</h3>
<p>In addition to the “regular” RRD Objects described above, one can define “aggregate” RRD Objects. Simiar to the aggregate functions which can be applied on multiple View objects, the aggrgeate RRD objects represent values produced by applying an aggregate function (SUM, AVG, etc) to a set of update objects. The resulting value is then updated in a RRD file and the object also represents a View object subject to display and view aggregation functions. An aggrgegate RRD object is defined by prepending a ‘+’ to the object id. Example:</p>
<pre>
- id: +agg.hosts.sysload                                # aggregate rrd object id, must start with + char
  op: AVG                                               # mandatory aggregate function to apply
  ids:                                                  # mandatory list of object ids
    - host.host1.sysload                                # regular rrd object id, currently must be defined before this object in the config
    - host.host2.sysload                                # regular rrd object id, currently must be defined before this object in the config
  interval: 60                                          # optional - default is the interval of the first object listed in the ids list
  title: "Localhost sysload (1/5/15 min)"               # optional title - object id will be used if no title is present
  rrd_type: GAUGE                                       # optional - if not set, the rrd_type of the first object will be used
  rrd_init_source: "/path/to/existing/file.rrd"         # optional - if defined SMG will pass --source <val> to rrdtool create
  stack: false                                          # optional - stack graph lines if true, default - false
  notify-fail: mail-asen,notif-pd                       # optional - sent command failures to these recipients (see notify- conf below)
  labels:                                               # optional - arbitrary map of key/valu labels, useful for filtering
    foo: bar                                            #            and grouping by
  vars:                                                 # optional list of all variables to graph. If not set the first object vars list will be used.
    - label: sl1min                                     # the variable label.
      min: 0                                            # optional - min accepted rrd value, default 0
      max: 1000                                         # optional - max accepted rrd value, default U (unlimmited)
      mu: "lavg"                                        # optional - measurement units, default - empty string
      lt: "LINE1"                                       # optional - line type, default is LINE1
      alert-warn-gt: 8                                  # optional - monitoring thresholds, details below
    - label: sl5min                                     # another variable def
    - label: sl15min                                    # a 3d variable def
</pre>
<p>As mentioned in the yaml comments above, some of the properties of the aggregate object will be assumed from the first object vars list, unless explicitly defined. It is up to the config to ensure that the list of objects to aggregate is compatible (and meaningful).</p>
<p><a name="view-objects" /></p>
<h3 id="view-objects">View objects</h3>
<p>As mentioned in the <a href="#concepts-view-objects">concepts overview</a> every RRD object is implicitly also a View object. Additional View objects can be defined in the configuration by referencing existing RRD objects too. These have two main purposes:</p>
<ul>
<li>to be able to graph only a subset of the RRD object vars and/or change their order by specifying the graphed vars as a list of indexes in the RRD object vars (see <a href="#gv">gv</a> below). Here is an example configuration for such an object (this will graph only the second var from the list of the referenced object vars).</li>
</ul>
<pre>
    - host.localhost.sysload.5m:                             # View object id
      title: "Localhost sysload - 5min only"                 # optional title - object id will be used if no title is present
      ref: host.localhost.sysload                            # object id of an already defined rrd object
      stack: false                                           # optional - stack graph lines if true, default - false
      gv:                                                    # a list of integers ("graph vars")
        - 1                                                  # index in ref object vars list
</pre>
<ul>
<li>to be able to graph a value calculated from the RRD object’s values using <a href="#cdef_vars">cdef_vars</a>. Here is an example definition of such an object which is referencing another object with 2 vars (not visible here) - one for varnish req/sec and the other for varnish cache hit/sec. The View object below defines a single cdef var(line) calculating its values by evaluating the cdef expression (calculating cache hit % in this case) <a href="#cdef_vars-cdef">explained below</a></li>
</ul>
<pre>
    - host.va1.varnishstat.hitperc:
      title: "va1 - varnishstat: cache_hit/client_req %"
      ref: host.va.varnishstat.client_req_hitttl
      cdef_vars:
        - label: "hitperc"
          mu: "%"
          cdef: "$ds1,100,*,$ds0,/"
</pre>
<p>One should not set both gv and cdef_vars on the same View object. If one does that the gv values will be ignored. Note that technically it is possible to do what gv does using just cdef_vars except that gv provides a simpler way to just select a subset or reorder graph lines.</p>
<p>View objects support the following properties:</p>
<ul>
<li><p>the <strong>object id</strong>: This is the unique object view id (must not conflict with other view or rrd objects). Check <a href="#rrd-objects">RRD Objects</a> for more info on allowed and good object ids.</p></li>
<li><p><strong>ref</strong>: mandatory reference (string) to a RRD object id</p></li>
<li><p><strong>title</strong>: - free form text description of the object. If not specified, the ref object title will be used.</p></li>
</ul>
<p><a name="gv" /></p>
<ul>
<li><strong>gv</strong> (graph vars) - This is a list of integers representing 0-based indexes in the ref object <a href="#obj-vars">vars</a> list. For example if the ref object has 3 vars and we want to graph the third and first in that order we would use the following gv definition:</li>
</ul>
<pre>
    ...
    gv:
      - 2
      - 0
</pre>
<p><a name="cdef_vars" /></p>
<ul>
<li><strong>cdef_vars</strong> - this defines a list of variables very similar to the referenced RRD object <a href="#obj-vars">vars</a>. It supports the same properties and the main difference is how the <a name="cdef_vars-cdef" /> <strong>cdef</strong> property is treated. On a RRD object <a href="#obj-vars-cdef">cdef</a> can only reference the variable its defined on by using the <em>$ds</em> special string. In cdef_vars we can reference all vars in the ref RRD object in a single <a href="http://oss.oetiker.ch/rrdtool/tut/rpntutorial.en.html">RPN expression</a> and produce a single graph line from multiple vars. The ref object variables are referenced in the expression by their 0-based index with $ds prefix - <em>$ds0</em>, <em>$ds1</em>, <em>$ds2</em> etc. In the above example we have</li>
</ul>
<pre>
      ...
      cdef_vars:
          ...
          cdef: "$ds1,100,*,$ds0,/"
</pre>
<blockquote>
<p>The cdef expression can be translated as (form right to left): <em>Divide the value of ( the product of the 2nd (<span class="math inline"><em>d</em><em>s</em>1)<em>v</em><em>a</em><em>r</em><em>w</em><em>i</em><em>t</em><em>h</em>100)<em>b</em><em>y</em><em>t</em><em>h</em><em>e</em><em>v</em><em>a</em><em>l</em><em>u</em><em>e</em><em>o</em><em>f</em><em>t</em><em>h</em><em>e</em>1<em>s</em><em>t</em>(</span>ds0) var</em>. Or <em>$ds1 * 100 / $ds0</em> in more conventional notation. In our case the $ds0 represents “requests/sec” and $ds1 represents “cache hits/sec”. So that expression is calculating the cache hit % (from all requests). Rddtool has great documentation on <a href="http://oss.oetiker.ch/rrdtool/tut/rpntutorial.en.html">RPN expressions</a> and I strongly recommend reading that for anyone who wants to write cdef expressions.</p>
</blockquote>
<p><a name="indexes" /></p>
<h3 id="indexes-1">Indexes</h3>
<p>In SMG an “index” represents a named “filter” which can be used to identify and display a group of graphs together. Also an index can define a parent and child indexes, so one can define a tree-like navigational structure using indexes. If an index does not have a parent index it is considered a “top-level” index. All top-level indexes are displayed on the SMG main page (by remote), together with their first-level child indexes.</p>
<p>Index objects are defined in the yaml along with the RRD and View objects and their object ids start with the <em>‘^’</em> special symbol.</p>
<p>Here is an example Index definition:</p>
<pre>
    - id: ^hosts.localhost       # index id, must start with a ^ char
      title: "localhost graphs"  # optional - id (sans the ^ char) will be used if not specified
      cols: 6                    # optional (default - the value of $dash-default-cols) how many coulmns of graph images to display
      rows: 10                   # optional (default - the value of $dash-default-rows) how many rows (max) to display. excess rows are paginated
      px: "host.localhost."      # optional filter: rrd object id prefix to match. Ignored if null (which is the default).
      sx: ...                    # optional filter: rrd object id suffix to match. Ignored if null (which is the default).
      rx: ...                    # optional filter: regex to match against rrd object id. Ignored if null (which is the default).
      rxx: ...                   # optional filter: exclude objects which ids match the supplied regex. Ignored if null (which is the default).
      trx: ...                   # optional filter: regex to match against object text representation (including title, var names etc). Ignored if null (which is the default).
      agg_op: ...                # optional "aggregate op"
      gb: ...                    # optional "group by" value
      gbp: ...                   # optional "group by param" value
      parent: some.index.id      # optinal parent index id. Indexes without parent are considered top-level
      children:                  # optional list of child index ids to display under this index
        - example.index.id1
        - example.index.id2
        - ...
      remote: "*"                # optional - index remote, default is null, use "*" to specify index matching all remotes.
                                 # Individual remote instances can be specified by using their comma-separated ids.
</pre>
<p>Index objects support the following properties:</p>
<ul>
<li><p>the <strong>index id</strong>: This is the unique index id, starting with the ^ symbol (must not conflict with other index ids).</p></li>
<li><p><strong>title</strong>: - free form text title of the index. If not specified, the id (sans the ^ char) will be used.</p></li>
<li><p><strong>desc</strong>: - optional free form text description of the index (displayed together with title on index pages).</p></li>
<li><p><strong>cols</strong>: (default - the value of the $dash-default-cols global) - optional number specifying in how many “columns” to display the rows of graphs. Note that this sets a max limit (and a hard “line break”), chances are that on smaller screens your browser will still wrap graph “rows” as needed for display.</p></li>
<li><p><strong>rows</strong>: (default - the value of the $dash-default-rows global) - optional number specifying how many rows (each having max <em>cols</em> graphs) to display, effectively setting the number of graphs SMG will display on a single page of results.</p></li>
</ul>
<p><a name="period" /></p>
<ul>
<li><p><strong>period</strong>: (default - 24h) - a SMG “period string” (or number - in seconds) specifying the displayed graphs time range starting point relative to “now”. The period string format is inspired by <a href="http://oss.oetiker.ch/rrdtool/doc/rrdfetch.en.html#ITIME_OFFSET_SPECIFICATION">rrdtool time offset</a> (technically it is a subset of it) but you generally set a point in time (relative to now) since which you want to see graphs. It is generally a number followed by an optional single char time specifier which can be one of the following:</p>
<ul>
<li><em>y</em> - for years,</li>
<li><em>m</em> - this is currently used for both minutes and months, If the number is less than 13 it will be considered to be a month otherwise - minutes. Use M to force specifying minutes.</li>
<li><em>d</em> - for days</li>
<li><em>h</em> - for hours _ <em>M</em> - for minutes</li>
<li>(None, just a number) - assumed to be seconds. The end point of the graphs can be set to be different than “now” by using a “period length” (<strong>pl</strong>) <a href="#graph-options">graph option</a>.</li>
</ul></li>
<li><p><strong>agg_op</strong>: (default - None) - A SMG aggregate operation string (one of <em>GROUP</em>, <em>STACK</em>, <em>SUM</em>, <em>SUMN</em>, <em>AVG</em>, <em>MAX</em> or <em>MIN</em> ). If that is specified SMG will directly apply the respective <a href="#concepts-aggregate-functions">aggregate operation</a> to the graphs resulting from the filter, before display.</p></li>
<li><p><strong>gb</strong>: (default - None) - Group By val (TODO)</p></li>
<li><p><strong>gbp</strong>: (default - None) - Grup By “param” val (TODO)</p></li>
<li><p><strong>xagg</strong>: (default - false) - By default, when SMG is executing aggregate operations it will execute them “per-remote” - result will have the aggrgeate graphs split and displayed by the remote instance they “live” in. It is possible to request aggregation across all remotes too - by setting the xagg value to <em>true</em>. Note that this is a relatively expensive operation - SMG has to download all neded remote RRD files to be able to produce a single graph from them so results can be expected to be a bit slower than normally.</p></li>
<li><p><strong>parent</strong>: (default None) - specifying a “parent” index id. Indexes not having a parent id are considered to be “top-level” and are displayed on the main index page (together with their first-level children). If set to some parent id this index will be displayed in the childs list of the parent.</p></li>
<li><p><strong>children</strong>: - optional yaml list of strings pointing to other index ids. The indexes pointed by these ids will be displayed as children for this index. Note that the target indexes do not need to have their parent pointed to this index. I.e. an index can have multiple parents that way.</p></li>
</ul>
<p>The remaining index properties represent a filter (with graph options). These deserve thir own subsection:</p>
<p><a name="filters" /></p>
<h4 id="filters-and-graph-options">Filters and graph options</h4>
<p>A filter (and its graph options) is configured as part of an index definition using the following properties (along with the rest index properties):</p>
<ul>
<li><p><strong>trx</strong> (Text Regex) - when set, only objects with titles, object ids, graph labels or measurement units matching the specified regular expressions will be matched by the filter.</p></li>
<li><p><strong>px</strong> (Prefix) - when set, only object ids having the specified prefix string (starting with it) will be matched by the filter. Note that this is not a regexp but a direct string comparison.</p></li>
<li><p><strong>sx</strong> (Suffix) - when set, only object ids having the specified suffix string (ending with it) will be matched by the filter.Note that this is not a regexp but a direct string comparison.</p></li>
<li><p><strong>rx</strong> (Regex) - when set, only object ids matching the specified regular expressions will be matched by the filter.</p></li>
<li><p><strong>rxx</strong> (Regex Exclude) - when set, only object ids NOT matching the specified regular expressions will be matched by the filter.</p></li>
<li><p><strong>prx</strong> (Parent regex filter) - when set, only object with parent/pre_fetch ids matching the specified regular expressions will be matched by the filter.</p></li>
<li><p><strong>lbls</strong> (Labels expression filter) - when set, only objects which have object labels matching the provided label expression will be matched by the filter. Note that object labels are a new feature (and separate from object vars graph display labels). Label expressions can consist of:</p>
<ul>
<li>just a label name - in which case object labels having that label name will match regardless of their label value</li>
<li>label-name=label-value - both the name and the value must mutch</li>
<li>label-name!=label-value - object must have label with the specified name but value must be different than label-value</li>
<li>label-name=~label-value - label value is treated as regex and object’s value for the same label must match that.</li>
<li>label-name!=~label-value - label value is treated as regex and object’s value for the same label must NOT match that. All of these can be prepended with an ! to inverse their effect (i.e. whetehr to include or exclude matching objects). The labels filter supports multiple expressions sepaarted by space. This means that spaces in label value filters are not currently supported (as a workaround - use regex and ).</li>
</ul></li>
<li><p><strong>remote</strong> (Remote instance, by default - None, meaning local). This should be either set to “*” (quoted in the yaml as the asterisk is special char) which means that this filter should filter across all available remotes or not set at all (meaning “local” filtering). When SMG displays remote index it will automatically populate its value when displaying (note that the “remote” definition is only meaningful in the context of another remote which references the former as some <em>remote id</em>).</p></li>
<li><p><strong>dhmap</strong> - (TODO) when set to true, SMG will not display Monitoring heatmap for that index.</p></li>
<li><p><strong>alerts</strong> - alert configurations defined for all objects matching this index. Check <a href="#monitoring">monitoring configuration</a> for more details.</p></li>
</ul>
<p><a name="graph-options" /></p>
<p>The remaining properties represent “Graph Options” - generally specifying some non-default options to display graphs. These are rarely specified in index definitions but more often - come from UI requests.</p>
<ul>
<li><p><strong>step</strong>: (default None, which means automatic) - an integer (in seconds) specifying how many seconds should a data point in the graph represent. This is rarely needed as SMG (rrdtool actually) will pick an optimal step (a.k.a. resolution) depending on the requested period and available RRAs.</p></li>
<li><p><strong>pl</strong>: (“period length”, default None) - this is a string or number following SMG <a href="#period">period string</a> format. It sets a time range (length) which we want the produced graphs to cover (still starting at the starting point defined in <strong>period</strong> parameter). So for example you could say “give me graphs starting 24h (period param) ago and covering 6h (pl param)”. Note that this is rarely as useful as it may seem at first sight. As time passes older RRD/RRA data gets averaged and loses detail, so if you decide that you want a graph covering 6h but starting a year ago, chances are that you will see flat horizontal lines representing the average values for the object vars for the given 6 hours.</p></li>
<li><p><strong>dpp</strong>: (disable period-over-period, default false) - by default SMG will plot two lines for every var in the graph - one (solid) for the values in the period and another (same color but dotted) - for the values covering the previous period (of same size). If desired one can disable that behavior by setting dpp to <em>true</em></p></li>
<li><p><strong>d95p</strong>: (disable 95%-ile ruler, default false) - by default SMG will plot a horisontal flat line (“ruler”) at the calculated maximum 95%-ile value (basically, removing the top-5% values, considered outliers). If desired one can disable the plotting of that line by setting d95p value to <em>true</em></p></li>
<li><p><strong>maxy</strong>: (maximum Y-value, default None) - a number setting a hard max limit on the Y-axis value of the displayed graphs.</p></li>
<li><p><strong>xsort</strong>: (integer, default 0) - When different than 0 SMG will treat that as a request to sort the outputted (on the page) graphs by the average value of the var which (1-based) index is equal to xsort. E.g set to 1 to sort by the first variable, 2 for the second etc. Graphs which have less variables than the requested xsort index will remain unsorted. Sorting is also described <a href="#concepts-sorting">here</a>.</p></li>
</ul>
<p><a name="hindexes" /></p>
<h3 id="hidden-indexes">Hidden Indexes</h3>
<p>Only difference in defining a hidden index from a regular one is that it has a ‘~’ character in the beginning of the index object id (instead of ‘^’) and the only difference in behavior is that the hidden one is not displayed on the index page(s).</p>
<p>Currently hidden indexes are only useful in the context of monitoring - to define a group of objects for which in turn to define alert thresholds, but not necessarily clutter the main page with all of the groups.</p>
<p><a name="cdash" /></p>
<h3 id="custom-dashboards-configuration">Custom dashboards configuration</h3>
<p>Custom dashboards are defined in the yaml configuration using the <strong>$cdash</strong> global variable.</p>
<p>The $cdash keyword defines a yaml map which must have an unique <strong>id</strong> property, an optional <strong>title</strong> and a list of <strong>items</strong> of various types. All item types have some common set of properties - an unique <strong>id</strong>, an optional <strong>title</strong>, <strong>width</strong> and <strong>height</strong> properties. The other mandatory propert is the <strong>type</strong> which can be one of the following:</p>
<ul>
<li><p><em>IndexGraphs</em> - the graphs produced by some defined in smg index. This item type requires an <strong>ix</strong> property specifying the index id. It also supports <strong>offset</strong> and <strong>limit</strong> properties in the list of graphs (default is to show all).</p></li>
<li><p><em>IndexStates</em> - svg heatmaps representing index states. Indexes are specified using the <strong>ixes</strong> propery which is a list of index ids. The svg image width is specified via the <strong>img_width</strong> property.</p></li>
<li><p><em>MonitorProblems</em> - current problems as visible on the monitor page. Supports customizing what is displayed using <strong>ms</strong> (minimum alert level) filter and also <strong>soft</strong> and <strong>slncd</strong> filter flags.</p></li>
<li><p><em>MonitorLog</em> - recent monitor/log entries. Supports customizing what is displayed using <strong>ms</strong> (minimum alert level) filter and also <strong>soft</strong> and <strong>slncd</strong> filter flags.</p></li>
<li><p><em>Plugin</em> - plugins can implement custom dashboard items and using custom (plugin-specific) configuration.</p></li>
<li><p><em>External</em> - and external web page displayed in an iframe. Requires an <strong>url</strong> parameter and a separate <strong>fheight</strong> (frame height) property from the standard <strong>height</strong>.</p></li>
<li><p><em>Container</em> - this is a special type of item which is a container for other items specified as a list under the <strong>items</strong> property.</p></li>
</ul>
<p>Example:</p>
<pre><code>- $cdash:
  id: noc
  title: NOC
  items:
    - id: alerts
      title: Active alerts
      type: MonitorProblems
      width: 350
      height: 600
    - id: alert-log
      title: Alert Log
      type: MonitorLog
      width: 350
      height: 600
      limit: 50
      ms: WARNING
    - id: jmx.premote-graphs
      type: IndexGraphs
      title: jmx.premote Graphs
      width: 700
      height: 600
      ix: jmx.premote
      limit: 2
    - id: group1
      type: Container
      width: 700
      height: 800
      items:
      - id: index.states
        title: Index States
        type: IndexStates
        width: 450
        height: 500
        img_width: 300
        ixes:
          - jmx.premote
          - localhost
      - id: calc-netext
        type: Plugin
        width: 700
        height: 300
        plugin_id: calc
        ix: some.id
    - id: google
      title: External web page
      type: External
      width: 800
      height: 620
      fheight: 600
      url: https://google.com/</code></pre>
<p><a name="monitoring" /></p>
<h3 id="monitoring-configuration">Monitoring configuration</h3>
<p>Every object variable (mapping to a graph line) can have zero or more alert configurations applied. Each alert config is a key -&gt; value pair where the key is a special keyword recognized by SMG and the value usually represents some alert threshold. Currently the following alert keywords are defined:</p>
<pre><code>alert-warn: NUM      # same as alert-warn-gte
alert-warn-gte: NUM  # warning alert if value greater than or equal to NUM
alert-warn-gt: NUM   # warning alert if value greater than NUM
alert-warn-lte: NUM  # warning alert if value is less than or equal to NUM
alert-warn-lt: NUM   # warning alert if value is less than NUM
alert-warn-eq: NUM   # warning alert if value is equal to NUM
alert-warn-neq: NUM  # warning alert if value is equal to NUM
alert-crit: NUM      # same as alert-crit-gte
alert-crit-gte: NUM  # critical alert if value greater than or equal to NUM
alert-crit-gt: NUM   # critical alert if value greater than NUM
alert-crit-lte: NUM  # critical alert if value is less than or equal to NUM
alert-crit-lt: NUM   # critical alert if value is less than NUM
alert-crit-eq: NUM   # critical alert if value is equal to NUM
alert-crit-neq: NUM   # critical alert if value is equal to NUM
alert-p-&lt;pluginId&gt;-&lt;checkId&gt;: # configure a plugin-implemented check for the value</code></pre>
<p>The built-in “mon” plugin implements the following three checks</p>
<pre><code>alert-p-mon-anom: &quot;&quot; # anomaly alert - detecting unusual spikes or drops
                     #   it accepts a string with 3 values separated by &quot;:&quot;
                     #   the default value (when empty string is provided) is
                     #   &quot;1.5:30m:30h&quot; which means 1.5 (relative) change
                     #   in the last 30 minutes period compared to the previous
                     #   30h period.
alert-p-mon-pop: &quot;...&quot; # period over period value check - detecting if the current
                     #   value has changed with certain thresholds over the same value
                     #   some period ago. It accepts a string with 4 values separated
                     #   by &quot;:&quot;.
                     #   The first value is a period and an optional resolution
                     #   separated by &quot;-&quot;. E.g. &quot;24h-1M&quot; means compare with value 24 hrs
                     #   ago over a 1 minute average. If the -1M part is omitted the
                     #   object interval will be used as resolution (that would be the
                     #   highest available resolution in the RRD file).
                     #   The second value is the comparison operator - one of lt(e),
                     #   gt(e) or eq.
                     #   The third and fourth values are the warning and critical
                     #   thresholds of change.
                     #   E.g. to define an warning alert if some value drops below 0.7
                     #   from yesterday and a critical alert if the value drops below 0.5
                     #   from yesterday, at a 5min-average resolution, one can use the
                     #   following config string: &quot;24h-5M:lt:0.7:0.5&quot;
                     #   Both warning and critical thresholds are optional, e.g. use
                     #   something like &quot;24h:lt:0.7&quot; to set only a warning threshold and
                     #   something like &quot;24h:lt::0.5&quot; to set only critical threshold.
alert-p-mon-ex: &quot;...&quot; # &quot;Extended&quot; check, supporting some special use cases, mainly related
                     #   to using different data resoulution than the update inteval (e.g.
                     #   to check the hourly average of given value despite the value being
                     #   updated every minute. Format is
                     #   &quot;&lt;step&gt;:&lt;op&gt;-&lt;warn_thresh&gt;:&lt;op&gt;-&lt;crit_thresh&gt;[:HH_MM-HH_MM[*&lt;day&gt;],...]&quot;
                     #   step is the time resolution at which we want the current value fetched
                     #   op is one of gt, gte, eq, lte, lt
                     #   warn_thresh and crit_thresh are the respective warning and critical
                     #   threshold numbers.
                     #   The final portion is optional and is a comma separated list of time
                     #   period specifications. Time period is specified by setting time of day
                     #   and/or day of week (first 3 letters from English weekdays) or month (number),
                     #   separated via *. The time of day is defined as a start and end (separated
                     #   by -) hour and minute (separated by _). The check can only trigger alerts
                     #   when the current time is within the time of day (if specified) and day of
                     #   week/month (if specified)</code></pre>
<p>Check <a href="#concepts-anomaly">here</a> for more details on how alert-p-mon-anom/anomaly detection works.</p>
<p>In addition to alert-* properties one can also define the following notify- settings, specifying a list of “recipients” ($notify-command ids) to be exectuted on “hard” errors (and recoveries) at the appropriate severity level (crit/warn/spike), the special “notify-disable” flag explicitly disabling notifications for the applicable object var or the notify-backoff value specifying at what interval non-recovered object alert notifications should be re-sent. The notify-strikes value determines how many consecutive error states to be considered a hard error and in turn - trigger alert notifications.</p>
<pre><code>notify-crit: notify-cmd-id-1,notify-cmd-id-2,...
# (Not relevant for var states) 
notify-fail: notify-cmd-id-1,notify-cmd-id-2,...
notify-warn: notify-cmd-id-1,notify-cmd-id-2,...
notify-anom: notify-cmd-id-1,notify-cmd-id-2,...
notify-disable: true
notify-backoff: 6h
notify-strikes: 3</code></pre>
<blockquote>
<p>In order to disable fetch error notifications for given object one must set “<em>notify-disable: true</em>” at the object level. Pre-fetch commands support notify-disable too.</p>
</blockquote>
<blockquote>
<p>When multiple conflicting notify-strikes values apply, SMG will use the minimal from these. When multiple conflicting notify-backoff values apply, SMG will use the maximal from these. Any applicable notify-disable set to true will result in disabled notifications.</p>
</blockquote>
<p>Currently there are two ways to apply alert/notify configs to any given object variable:</p>
<ul>
<li>Inline with the object variable as part of the variable definition properties. E.g the following will define thresholds for two variable labelled sl1min and sl5min with values 10/8 which if exceeded will generate a “warning” alert. The sl5min one will also trigger the (defined elsewhere) notify-command with id mail-on-warn where the sl1min value will not trigger notification commands.</li>
</ul>
<pre>
  ...
  vars:
    - label: sl1min
      ...
      alert-warn-gt: 10
      notify-disable: true
    - label: sl5min
      ...
      alert-warn-gt: 8
      notify-warn: mail-on-warn
      notify-backoff: 1h
</pre>
<ul>
<li>As part of indexes (including hidden indexes) under the special alerts property. Examples:</li>
</ul>
<pre>
  ...
  notify-fail: ...
  notify-strikes: 5
  alerts:
   - label: sl1min   # any objects matching the index filter and also matching the sl1min label
     alert-warn-gt: 3
     notify-warn: mail-on-warn
     alert-crit-gt: 8
     notify-crit: mail-on-crit
   - label: 1         # when number - it will be used as a 0-based index in the variables array
     alert-warn-gt: 3
     alert-crit-gt: 8
   - label: scur
     alert-p-mon-anom: ""
</pre>
<p>The alerts property is an array of yaml objects each specifying a “label” and one or more alert thresholds or notify- properties. If the label is an integer number it will be interpreted as an index in the list of variables of the objects matching the index filter. For example one can define default anomaly (spike/drop) detection on all objects using the following config (just add more alerts defs if there are objects with more than 8 vars):</p>
<pre>
- ~all.alert.spikes:
  # empty filter means match all
  alerts:
    - label: 0
      alert-p-mon-anom: ""
    - label: 1
      alert-p-mon-anom: ""
    - label: 2
      alert-p-mon-anom: ""
    - label: 3
      alert-p-mon-anom: ""
    - label: 4
      alert-p-mon-anom: ""
    - label: 5
      alert-p-mon-anom: ""
    - label: 6
      alert-p-mon-anom: ""
    - label: 7
      alert-p-mon-anom: ""
</pre>
<p><a name="plugins-conf" /></p>
<h2 id="bundled-plugins-configuration">Bundled Plugins configuration</h2>
<ul>
<li><strong>calc</strong> - exposes UI for graphing the result of arbitrary math expressions Conf file (smgconf/calc-plugin.yml) supports pre-defined expressions which will show up in the UI for easy access. Example</li>
</ul>
<pre>
     calc:
       expressions:
         - expr_id:
            title: "Test expression"
            expr: "localhost.sysload[0] + localhost.dummy[1]"
            period: 24h
            step: 60
            maxy: 1000
            dpp: off
            d95p: off
</pre>
<ul>
<li><p><strong>cc</strong> - “Common Commands” plugin, exposes commands to use in the regular object commands. Subcommands:</p>
<ul>
<li><p>:cc csv</p>
<pre>
 :cc csv parse [parse opts] [format]
   -d|--delim &lt;char> (default ',')
   -nh|--no-header  - csv has no header row
   -sh|--strict-header - if set parse will abort on duplicate or missing header forgiven column
   -h|--headers hdr1,hdr2,...  - set custom header names based on position
  [format] (default - DEFAULT) - apache commons csv pre-defined format name (e.g. EXCEL)

 :cc csv get [get opts] &lt;row selectors (k=v)> &lt;val selectors>
   -e0|--empty-as-0 - if set non existing/empty values will return "0.0"
   -eN|--empty-as-nan - if set non existing/empty values will return "NaN"
  &lt;row selectors> - col1=val1 col2=val2
     col is either a number (0-based column index) or a column header name
     val is the value which the row must have in the respective column
       if val starts with '~' it will be treated as regex
       if val start with '!' the mathc is inverted (i.e. the row must not have that value)
       use !~... for negative regex match
  &lt;val selectors> - list of zero-based column indexes or column header names
  In both cases if a column header name is a number it can be "quoted" in the definition so
  that it is not treated as column index

 :cc csv pget [get opts]
   parse the csv using default parse options and get value using provided get options in one shot
  </pre></li>
<li><p>:cc kv</p>
<pre>
  :cc kv parse [opts]
   -d|--delim &lt;str> (default '=')
   -n|--normalize (default - false) - convert kb/mb/gb suffixes and strip surrounding whitespace

  :cc kv get [opts] &lt;key1> &lt;key2...>
   -d |--default &lt;str> (default - None) - return the default value if key is not found

  :cc kv pget [get opts] &lt;key1> &lt;key2>
  </pre></li>
<li><p>:cc ln</p>
<pre>
  :cc ln [opts] index1 [index2...]
     -s &lt;separator_regex> | --separator &lt;separator_regex> (default is any whitespace - \s+)
     -js &lt;join_str> | --join-separator &lt;join_str> (default is space)
     -jn | --join-new-line
  :cc ln -s ", " 1
  split a line using the separator (regex) string and output the specified 1-based elements
  separated by space. 0 means to output the entire input line
  </pre></li>
<li><p>:cc map</p>
<pre>
  :cc map k1=v1 k2=v2 [default]
    map input lines (kX string values) to specified output values (vX string values)
    if a default is specified it will be returned for not matching inout lines
    otherwise unmatched input line will result in error
  </pre></li>
<li><p>:cc rpn</p>
<pre>
  :cc rpn &lt;expr1> &lt;expr2...>
   treat input as update data (list of Doubles) and compute RPN expressions from them
   input ines are mapped to $dsX values in the expression where X is the zero-based
   index in the list. Output one result (Double) per RPN expression provided
  </pre></li>
<li><p>:cc rx.. - in all cases &lt;regex&gt; can be quoted using single quotes, double quotes, ‘|’ or ‘/’.</p>
<ul>
<li>:cc rxm
<pre>
  :cc rxm [-d|--default 'value'] &lt;regex>
  returns entire input (all lines) if matching. if a default value is
  provided via the -d|--default flag value it will be outputted. Result
  will be error otherwise.
  </pre></li>
<li>:cc rxml
<pre>
  :cc rxml [-d|--default 'value'] &lt;regex>
  returns individual matching lines. error if no default value is provided
  and no matching lines (like grep). If a default value is provided (via
  the -d or --default option value) - it will be returned with success response.
  </pre></li>
<li>:cc rxe
<pre>
  :cc rxe &lt;regex_with_match_groups> &lt;mgrpoupIdx1> &lt;mgrpoupIdx2>
  apply the regex on the entire input (as a string, possibly with new lines) and print
  each match group on a separate line
  </pre></li>
<li>:cc rxel
<pre>
  :cc rxel &lt;regex_with_match_groups> &lt;mgrpoupIdx1> &lt;mgrpoupIdx2>
  apply the regex on each input line separately and print each line's match groups on one line
  separated by space
  e.g. :cc rxel |.*(\\d+).*| 1
  </pre></li>
<li>:cc rx_repl
<pre>
  :cc rx_repl &lt;regex> [replacement]
  for each line in input replace all occurrences of regex with replacements (empty if not specified) str
  </pre></li>
</ul></li>
<li><p>:cc snmpp</p>
<pre>
  :cc snmpp parse [parse opts]
      -l|--long-keys - keep the full SNMP OID key value (normally the part until the first :: is stripped)

  :cc snmpp get [get opts] &lt;key1> &lt;key2>
      -d|--default &lt;val> - return the supplied default value if a keyX is not found
      missing key with no default value provided will result in error

  :cc snmpp pget [get opts] &lt;key1> &lt;key2>
      parse and get in one shot, no parse options supported
  </pre></li>
</ul></li>
<li><p><strong>influxdb</strong> - influxdb config is specified using the following globals (part of the SMG config), with defaults:</p>
<pre>
  - $influxdb_write_host_port: "localhost:8086"
  - $influxdb_write_url_path: "/api/v2/write?bucket=smg_db&precision=s"
  - $influxdb_write_url_proto: "http"
  - $influxdb_write_batch_size: 1000
  - $influxdb_write_timeout_ms: 30000
  - $influxdb_strip_group_index: true
  </pre></li>
<li><p><strong>jmx</strong> - exposes the following commands to be used in configs</p>
<ul>
<li>:jmx con host:port</li>
<li>:jmx get host:port jmxObj jmxAttr1 jmxAttr2..
<pre>
  :jmx get host:port java.lang:type=Memory HeapMemoryUsage:used HeapMemoryUsage:committed
  </pre></li>
</ul></li>
<li><p><strong>scrape</strong> - Plugin to natively handle metrics exposed in OpenMetrics (Prometehus) format. See smgconf/scrape-plugin.yml for example target configuration (the local SMG instance). The Scrape plugin implements SMG objects config generation based on Prometheus/OpenMetrics URL (or data). So (just like Prometheus) it is possible to configure only scrape targets (/metrcis URLs) and the included stats will be auto discovered by SMG. Scrape needs a SMG conf output dir which it can manage (add/remove confs) if told to do so. That directory MUST be included by the regular SMG conf (/etc/smg/config.yml). This is the case with the “official” docker image/config. Scrape defines the following plugin commands (used by the generated SMG conf):</p>
<ul>
<li>:scrape http <url> - a plain http(s) call to GET a http response from the provided url, can also be done with curl instead. This command accepts two options:
<ul>
<li>:scrape http :secure <url> - by default it will ignore ssl cert errors unless :secure is specified.</li>
<li>:scrape http :tokenf /path/to/token_file <url> - the contents of the token_file will be used as an “Authorization: Bearer <token>” value. Useful when deployed in k8s and need to access protected resources for monitoring via ServiceAccount</li>
</ul></li>
<li>:scrape parse - parse the output of an :http (or curl) command into internal representation. Must be defined as a child of a command outputting metrcis data (text), so in theory it doesn’t <em>have</em> to be retreived over HTTP. The internal representation converts all metrics (lines) to a map of key -&gt; value pairs where the key is generated from the metrics name and all labels (these have to be unique for Prometheus to work too). Also check :scrape get below.</li>
<li>:scrape fetch [:secure] [:tokenf /path/to/token_file] <url> - a combined :http and :parse command - get the metrics URL and parse the data in one shot. Fetch supports the same :secure and :tokenf options and also requires an URL argument</li>
<li>:scrape get <uid1> [<uid2>…] - retrieve a value from parsed OpenMetrics stats. Must be defined as a child of either a :fetch or a :parse command. The uids are generated at parse time and are predictable - it represents the metric name and all labels key/values appended to it and separated by dots. “Unsafe” SMG object id characters are converted to underscore. In te unlikely case of id conflict after that conversion is done the conflicting uids will have an additional ._N suffix where N is the position of the object in the list of conflicting uids.</li>
</ul></li>
<li><p><strong>autoconf</strong> - TODO See smgconf/autoconf-plugin.yml and smgconf/ac-templates/</p></li>
<li><p><strong>kube</strong> - TODO See smgconf/kube-plugin.yml</p></li>
<li><p><strong>mon</strong> - exposes the following alert definitions</p>
<ul>
<li>alert-p-mon-anom: “change_thresh:short_period:long_period”
<ul>
<li>e.g. alert-p-mon-anom: “1.5:30m:30h”</li>
</ul></li>
<li>alert-p-mon-ex: “period:warn_op-warn_thresh:crit_op-crit_thresh:active_time”
<ul>
<li>e.g. alert-p-mon-ex: "24h:lt-0.7:lt-0.5:18_00-20_00*mon"</li>
</ul></li>
<li>alert-p-mon-pop: “long_per-short_per:op:warn_thresh:optional_crit_thresh”
<ul>
<li>e.g. alert-p-mon-pop: “24h-5m:lt:0.7” - check the short_per (5m) average value against the same value long_per (24h) ago, and compare the difference (proportion) using the provided op (lt, can be lt, lte, gt, gte) against the configured warning (0.7) and optional critical thresholds</li>
</ul></li>
</ul></li>
</ul>
<p><a name="running"></p>
<h2 id="running-and-troubleshooting">Running and troubleshooting</h2>
<p><a name="docker-mode" /></p>
<h3 id="run-in-a-container">Run in a container</h3>
<ul>
<li><p>mkdir -p /opt/smg/data /etc/smg/conf.d</p></li>
<li><p>docker run -d –name smg -p 9000:9000 -v /opt/smg/data -v /etc/smg/conf.d/ gcr.io/asen-smg/smulegrapher:latest</p></li>
<li><p>Point your browser to http://$DOCKER_HOST:9000 (the local metrics stats should show up in a minute or two)</p></li>
<li><p>Then add stuff under /etc/smg/conf.d and to reload conig use one of:</p>
<ul>
<li>docker exec smg /opt/smg/inst/smg/smgscripts/reload-conf.sh</li>
<li>curl -X POST http://$DOCKER_HOST:9000/reload</li>
</ul></li>
</ul>
<p><a name="k8s-mode" /></p>
<h3 id="run-in-k8s">Run in k8s</h3>
<p>Check the k8s/ dir for example deployment yamls, including in-cluster monitoring with auto-discovery (similar to Prometheus)</p>
<p><a name="classic-mode" /></p>
<h3 id="classic-mode">Classic mode</h3>
<p><a name="pre-reqs" /></p>
<h4 id="pre-requisites">Pre-requisites</h4>
<p>SMG needs the following software to run.</p>
<ul>
<li>SMG needs <strong>bash</strong> and <strong>gnu timeout</strong> to work out of the box. Bash is available on pretty much any unix installation and gnu timeout may have to be installed (on e.g. Mac). It should be possible to run under Windows using cygwin but never tried.</li>
</ul>
<blockquote>
<p>Note: The “bash” and “timeout” commands are actually configurable in application.conf and can be replaced with other commands with similar functionality. E.g. in theory it should be possible to replace bash with cmd.exe.</p>
</blockquote>
<ul>
<li><p><strong>rrdtool</strong> - <a href="http://oss.oetiker.ch/rrdtool/index.en.html">rrdtool</a> is available as a package on most linux distributions. It comes with <strong>rrdcached</strong> - a “caching” daemon which can be used for more efficient updates (rrdtool will not write directly to files but will send updates to rrdcached for batch updates). Although using rrdcached is optional (check the <a href="#rrd_socket">$rrd_socket global config option</a>) it is highly recommended if you plan to do tens of thousands of updates every minute.</p></li>
<li><p><strong>Java 11+</strong> - SMG is written in Scala and needs a JVM (Java 11+) to run. One must set the <strong>JAVA_HOME</strong> environment variable pointed to that before launching SMG.</p></li>
<li><p><strong>httpd</strong> (optional) - SMG comes with its own embedded http server however since images are served as files from the filesystem it is more efficient to use a native http server to serve these (e.g. Apache or Nginx). For this to work one would setup the http server as a reverse proxy to the SMG instance but bypassing SMG when serving images. Here is an example apache conf file to enable httpd listening on port 9080 (in this case SMG is told to output its images in the /var/www/html/smgimages dir via the <a href="#img_dir">$img_dir config option</a>):</p></li>
</ul>
<pre>
    Listen 9080
    &lt;VirtualHost *:9080>
        ProxyPass  /assets/smg !
        ProxyPass        /  http://localhost:9000/
        ProxyPassReverse /  http://localhost:9000/
        Alias /assets/smg /var/www/html/smgimages
    &lt;/VirtualHost>
</pre>
<p><a name="install-tgz" /></p>
<h4 id="installation-from-.tgz-bundle">Installation from .tgz bundle</h4>
<p>SMG comes as a pre-built tgz archive named like <em>smg-$VERSION.tgz</em> (e.g. smg-0.3.tgz). You can unpack that anywhere which will be the SMG installation dir. Here are example commands to unpack SMG in /opt/smg:</p>
<pre>
# cd /opt
# wget https://github.com/asen/smg/releases/download/v1.3/smg-1.3.tgz
# tar -xf smg-*.tgz
# mv smg-* smg # (or ln -s smg-* smg)
</pre>
<p>SMG comes with start and stop and scripts which in the above example would be available as:</p>
<ul>
<li><p><strong>/opt/smg/start-smg.sh</strong> - use this to start SMG as a daemon process. It requires JAVA_HOME to be pointed to a Java 8 installation.</p></li>
<li><p><strong>/opt/smg/stop-smg.sh</strong> - use this to gracefully stop the running as a daemon SMG process.</p></li>
</ul>
<p>Before you start SMG you need to create a basic <strong>/etc/smg/config.yml</strong> file and likely define at least a few RRD objects. One can use the smgconf/config.yml file inside the installation dir as example and should check the <a href="#config">configuration reference</a> for more details. Note that SMG will happily start with empty objects list (not that this is much useful beyond the ability to access this documentation when setting up).</p>
<p>Once you start SMG you can access it by pointing your browser at port 9000 (this is the default listen port). If using the httpd.conf example above, that would be port 9080.</p>
<p>Of course one would likely to define many objects before using SMG for real. Check the <a href="#config">configuration reference</a> for more details. We at Smule use chef to manage our servers and also to genereate most of our SMG configuration (based on hosts/services templates). Describing this in detail is beyond the scope of this documentation - use your imagination.</p>
<p>One important note is that whenever you update the yaml config file you need to tell the running SMG to reload its cofniguration (without actually restarting SMG). This is done via a http POST request like this:</p>
<pre>
    curl -X POST http://localhost:9000/reload
</pre>
<p>Or use the bundled with SMG bash wrapper around that command available as <strong>smgscripts/reload-conf.sh</strong> (relative to the install dir)</p>
<p>In addition, SMG is highly tunable via its Play framework’s application.conf. Check the <a href="#running">Running and troubleshooting</a> section for more details.</p>
<p><a name="install-src" /></p>
<h4 id="installation-from-sources">Installation from sources</h4>
<ul>
<li>This is mostly meant for development purposes.</li>
</ul>
<h4 id="reverse-proxy">Reverse proxy</h4>
<ul>
<li>see the k8s/ deployment with nginx in front of the Play app</li>
<li>example apache Reverse proxy conf</li>
</ul>
<pre>
        Listen 9080

        &lt;VirtualHost *:9080>
            # optional config to intercept /proxy/ requests to the respective remotes
            # and not have the SMG JVM do the proxying
            ProxyPass        /proxy/some-dc/  http://smg1.some-dc.myorg.com:9080/
            ProxyPassReverse /proxy/some-dc/  http://smg1.some-dc.myorg.com:9080/
            ProxyPass        /proxy/other-dc/ http://smg2.other-dc.myorg.com:9080/
            ProxyPassReverse /proxy/other-dc/ http://smg2.other-dc.myorg.com:9080/

            # do not proxy static files/images but serve them directly
            # from the configured SMG $img_dir
            ProxyPass  /assets/smg !
            Alias /assets/smg /opt/smg/public/smg

            # the actual proxy to SMG
            ProxyPass        /  http://localhost:9000/
            ProxyPassReverse /  http://localhost:9000/
        &lt;/VirtualHost>
</pre>
<ul>
<li><p>application.conf</p></li>
<li><p>logs</p></li>
</ul>
<p><a name="dev-setup"></p>
<h2 id="developer-documentation">Developer documentation</h2>
<p>Use the source …</p>
<h3 id="development-setup">Development setup</h3>
<ul>
<li><p>Install JDK 11+&lt;</p></li>
<li><p>Install rrdtool and coreutils (for gnu timeout command). E.g. with homebrew on Mac:</p>
<p>$ brew install rrdtool coreutils</p></li>
<li><p>(Only applicable on Mac) SMG currently needs to use gnu timeout where the default timeout command on Mac is different. There are two ways to address this (after installing coreutiles and gtimeout)</p>
<ul>
<li>change application.conf:</li>
</ul>
<pre>
  # Use smg.timeoutCommand to override the timeout command executable (e.g. gtimeout on mac with homebrew)
  smg.timeoutCommand = "gtimeout"
  </pre>
<ul>
<li>Link /usr/local/bin/timeout to /usr/local/bin/gtimeout on your Mac (that assumes that /usr/local/bin is before /usr/bin in your $PATH</li>
</ul>
<pre>
  ln -s /usr/local/bin/gtimeout /usr/local/bin/timeout
  </pre>
<p>&lt;</p></li>
<li><p>Run:</p></li>
</ul>
<pre>
    $ cd smg
    $ JAVA_HOME=$(/usr/libexec/java_home -v 11) ./run-dev.sh
</pre>
</body>
</html>
