@import com.smule.smg.SMGImageView
@import com.smule.smg.SMGFilter
@import com.smule.smg.GrapherApi ; val predefPeriods = GrapherApi.detailPeriods
@import com.smule.smg.SMGRemote
@import com.smule.smg.SMGIndex
@import com.smule.smg.SMGPlugin
@import com.smule.smg.GraphOptions
@import com.smule.smg.SMGMonState
@import com.smule.smg.SMGMonStateAgg
@import controllers.DashboardExtraParams

@(plugins: Seq[SMGPlugin], idx: Option[SMGIndex], parentIdx: Option[SMGIndex],
  byRemote: Seq[(String, Seq[SMGImageView])], flt: SMGFilter, dep: DashboardExtraParams, aggOp: Option[String],
  maxPg: Int, dispCount: Int, slicedCount: Int , tlCount: Int, availRemotes: Seq[SMGRemote],
  cwidth: Int, gopts: GraphOptions, showMs:Boolean, monData: Map[String, Seq[SMGMonState]],
  monOverviewOids: Seq[String], errorMsg: Option[String])(implicit flash: Flash)

@main("SMG - " + (if (idx.isDefined) idx.get.title else flt.humanText), plugins) {

  @if(errorMsg.isDefined){
    <div align="center"><h4><font color="red">Error: @errorMsg.get</font></h4></div>
  }

  @if(idx.nonEmpty) {
    <h3>Index: @idx.get.title
    @if(idx.get.desc.isDefined) {
      (@idx.get.desc.get)
    }
    </h3>
    @if(showMs){ @monitorSvgRefIndex(idx.get.id) }
    @if(parentIdx.isDefined) {
      <h4>
        Parent: <a href="/dash?@parentIdx.get.asUrl">@parentIdx.get.title</a>
        @if(parentIdx.get.rows.isEmpty || parentIdx.get.rows.get > 0){
          @for( p <- predefPeriods) {
          <a href="/dash?@parentIdx.get.asUrlForPeriod(p)">(@p)</a>
          }
        }
        @if(parentIdx.get.desc.isDefined) {
        (@parentIdx.get.desc.get)
        }
      </h4>
    }
    @indexItem(idx.get, predefPeriods, 1)
    <hr>
  }

@if(dep.rows > 0) {
  @filter(flt, dep.period, dep.cols, dep.rows, predefPeriods, availRemotes, aggOp,
          byRemote.nonEmpty && byRemote.tail.nonEmpty, dep.xRemoteAgg, gopts)

  @if(aggOp.isEmpty){
  @displaySelectHeader()
  }

  <div class="alert alert-success">
    Displaying @dispCount @if(aggOp.isDefined){ aggregate (@aggOp.get) } graphs (using @slicedCount out of @tlCount matching objects) in max @dep.cols columns and max @dep.rows rows.
  </div>

  @if(showMs){
    @monitorSvgRefObjects(monOverviewOids)
    @monStateListActions(monData.values.toSeq.flatten)
  }

  @if(aggOp.isEmpty){
    @pages(dep.period, flt, dep.cols, dep.rows, dep.pg, maxPg)
  }

  @for( (remoteId, lst) <- byRemote) {
    <h3>@if(remoteId == "") { Local } else { Remote: @remoteId}</h3>
    <div class="smgraphcontainer">
      <div class="smgrow">
      @for( (g, ix) <- lst.zipWithIndex) {
        <div class="smgcell" style="max-width: @{cwidth}px;">
          <!-- @g.obj -->
          <a name="@g.obj.id" ></a> <a name="@g.period"></a> <a name="@g.obj.id-@g.period"></a>
          <div class="smgraph">
            <h4>@g.obj.title (@g.period, @g.resolution(gopts.step))
              @if(g.obj.stack) {
                (stacked)
              }
              [<a href="@g.fetchUrl">csv</a>,<a href="@g.fetchUrl&d=1">dl</a>]
            </h4>
            <div class="subtitle-div">
              <div class="subtitle-div">
                @{g.obj.id} (@{g.obj.rrdType}) [<a href="#@g.obj.id" >#</a>]
                @for(pa <- plugins.flatMap(_.actions)){
                [<a href="@{pa.actionUrl(g.obj, dep.period)}">@{pa.name}</a>]
                }
              </div>
              @if(aggOp.isEmpty){
              @displaySelectElem(g)
              }
              @if(showMs && monData.contains(g.obj.id)){
              <div>
                <div class="subtitle-div">
                  @monitorSvgObjects(monData(g.obj.id), Some(monData(g.obj.id).size))
                </div>
                @if(aggOp.isEmpty && monData.contains(g.obj.id)){
                  @defining(SMGMonStateAgg.aggByParentId(monData(g.obj.id)).headOption.map(_._2)) { objStateOpt =>
                    @if(objStateOpt.isDefined){
                    <div class="subtitle-div">
                    @monStateActions(objStateOpt.get, None)
                    </div>
                    }
                  }
                }
              </div>
              }
            </div>
            <a href="@g.obj.showUrl"><img src="@g.imageUrl" alt="@g.imageUrl" /></a>
          </div>
        </div>
        @if(((ix + 1) % dep.cols) == 0) {
        </div><hr/><div class="smgrow">
        }
      }
      </div>
    </div>
  }

  @if(aggOp.isEmpty){
    @pages(dep.period, flt, dep.cols, dep.rows, dep.pg, maxPg)
  }
}

}
